/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Mon Jan 26 2026 19:59:59 GMT+0530 (India Standard Time)
	Description : CombineMaster Save Service Interface for code
	WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS
*/

//Use the following global objects as required.
//dsclientUtil - For data service related actions.
//Strings - For Strings dictionary. refer ../common/strings.js
//appcommon - For common help utils. refer ../common/common.js

var app = require('app');

var TenantSaveCodeInterface = app.getTenantWSInterface('BCSFuel', 'master/savecode');

if (typeof TenantSaveCodeInterface === 'undefined')
	TenantSaveCodeInterface = {};

module.exports = {
	onLoad: function(params) {
		var rObj = {
			"override": false,
			"params": params,
		};


		if (TenantSaveCodeInterface && TenantSaveCodeInterface.onLoad) {
			rObj = TenantSaveCodeInterface.onLoad(params);
		}

		return rObj;
	},

	beforeData: function (params) {

		var rObj = {
			"override": false,
			"params": params
		};

		var refFlag = false;
		var deletedDup = false;

		// Flags to tell the UI exactly where the conflict is
		var conflictSources = {
			vendor: false,
			utilization: false,
			purchase: false,
			consumption: false,
			loss: false
		};

		var fuelCodeArr;
		var deletedObjectsArr = [];
		var deletedWithRefArr = [];

		var paramData = JSON.parse(params.data);
		var paramArr = JSON.parse(paramData.master_data);

		var MASTER_TABLE = "bcsfuel_code";

		var queryParams = {
			"cols": [
				"master_name",
				"master_data",
				"edited_by",
				"edited_on"
			],
			"filter": [{
				"col": "master_name",
				"op": "=",
				"val": MASTER_TABLE
			}]
		};

		var masterRespObj = dsclientUtil.execute(queryParams, "BCSFuel", "bcsfuel_combined_master", "query");

		if (masterRespObj && masterRespObj.code === 200 && masterRespObj.data && masterRespObj.data.length > 0) {

			fuelCodeArr = JSON.parse(masterRespObj.data[0].master_data);

			// Identify Deleted Items
			for (var i = 0; i < fuelCodeArr.length; i++) {
				var found = false;
				var existingObj = fuelCodeArr[i];

				for (var j = 0; j < paramArr.length; j++) {
					if (existingObj.id === paramArr[j].id) {
						found = true;
						break;
					}
				}

				if (!found) deletedObjectsArr.push(existingObj);
			}

			if (deletedObjectsArr.length > 0) {

				//Soft Duplicate Handling

				for (var p = 0; p < paramArr.length; p++) {
					for (var d = 0; d < deletedObjectsArr.length; d++) {
						if (paramArr[p].id == null && normalize(paramArr[p].code) === normalize(deletedObjectsArr[d].code)) {
							paramArr[p].id = deletedObjectsArr[d].id;
							deletedObjectsArr.splice(d, 1);
							deletedDup = true;
							break;
						}
					}
				}

				// Prepare List of IDs to Check
				if (deletedObjectsArr.length > 0) {

					var deletedIdsOnly = [];
					for (var x = 0; x < deletedObjectsArr.length; x++) {
						deletedIdsOnly.push(deletedObjectsArr[x].id);
					}

					var formattedIds = _formatArrForInQuery(deletedIdsOnly);

					// Fuel Vendors
					var vendorResp = dsclientUtil.execute({
						"cols": ["master_name", "master_data"],
						"filter": [{ "col": "master_name", "op": "=", "val": "bcsfuel_vendor" }]
					}, "BCSFuel", "bcsfuel_combined_master", "query");

					if (vendorResp && vendorResp.code === 200 && vendorResp.data.length > 0) {
						var vData = JSON.parse(vendorResp.data[0].master_data);
						for (var v = 0; v < vData.length; v++) {
							if (deletedIdsOnly.indexOf(vData[v].fuel_code_id) > -1) {
								_addToDeletedRef(vData[v].fuel_code_id, deletedObjectsArr, deletedWithRefArr);
								refFlag = true;
								conflictSources.vendor = true;
							}
						}
					}

					// Utilization Points
					var utilResp = dsclientUtil.execute({
						"cols": ["master_name", "master_data"],
						"filter": [{ "col": "master_name", "op": "=", "val": "bcsfuel_utilizationPoint" }]
					}, "BCSFuel", "bcsfuel_combined_master", "query");

					if (utilResp && utilResp.code === 200 && utilResp.data.length > 0) {
						var uData = JSON.parse(utilResp.data[0].master_data);
						for (var u = 0; u < uData.length; u++) {
							if (deletedIdsOnly.indexOf(uData[u].fuel_code_id) > -1) {
								_addToDeletedRef(uData[u].fuel_code_id, deletedObjectsArr, deletedWithRefArr);
								refFlag = true;
								conflictSources.utilization = true;
							}
						}
					}

					var checkRefQuery = {
						"cols": ["fuel_code_id"],
						"filter": [{
							"col": "fuel_code_id",
							"op": "IN",
							"val": formattedIds
						}]
					};

					// Purchase
					var purchaseResp = dsclientUtil.execute(checkRefQuery, "BCSFuel", "bcsfuel_purchase", "query");
					if (purchaseResp && purchaseResp.code === 200 && purchaseResp.data.length > 0) {
						for (var pr = 0; pr < purchaseResp.data.length; pr++) {
							_addToDeletedRef(purchaseResp.data[pr].fuel_code_id, deletedObjectsArr, deletedWithRefArr);
						}
						refFlag = true;
						conflictSources.purchase = true;
					}

					// Consumption
					var consumptionResp = dsclientUtil.execute(checkRefQuery, "BCSFuel", "bcsfuel_consumption", "query");
					if (consumptionResp && consumptionResp.code === 200 && consumptionResp.data.length > 0) {
						for (var c = 0; c < consumptionResp.data.length; c++) {
							_addToDeletedRef(consumptionResp.data[c].fuel_code_id, deletedObjectsArr, deletedWithRefArr);
						}
						refFlag = true;
						conflictSources.consumption = true;
					}

					// Loss
					var lossResp = dsclientUtil.execute(checkRefQuery, "BCSFuel", "bcsfuel_loss", "query");
					if (lossResp && lossResp.code === 200 && lossResp.data.length > 0) {
						for (var l = 0; l < lossResp.data.length; l++) {
							_addToDeletedRef(lossResp.data[l].fuel_code_id, deletedObjectsArr, deletedWithRefArr);
						}
						refFlag = true;
						conflictSources.loss = true;
					}
				}

				if (deletedWithRefArr.length > 0 || deletedDup === true) {

					var finalDataToSave = paramArr.concat(deletedWithRefArr);

					var masterUpdateObj = {
						"master_name": MASTER_TABLE,
						"master_data": JSON.stringify(finalDataToSave),
						"edited_by": paramData.edited_by,
						"edited_on": paramData.edited_on,
						"_sid": masterRespObj.data[0]._sid
					};

					var respObj = dsclientUtil.execute({ data: JSON.stringify(masterUpdateObj) }, "BCSFuel", "bcsfuel_combined_master","update");

					if (respObj && respObj.code === 200) {
						rObj.override = true;
						rObj.resp = {
							"code": 400,
							"msg": Strings.FOREGIN_REFERENCE_FOUND || "Cannot delete: Data is in use.",
							"err_code": 422,
							"data": JSON.parse(respObj.data.master_data),
							"deletedWithRefArr": deletedWithRefArr,
							"refFlag": refFlag,
							"deletedDup": deletedDup,
							"conflictSources": conflictSources
						};
					} else {
						rObj.override = true;
						rObj.resp = { "code": 400, 
									 "msg": "Error Saving Data",
									 "err_code": 400,
									 "respObj": respObj
									};
					}
				}
			}
		}

		if (TenantSaveCodeInterface && TenantSaveCodeInterface.beforeData) {
			rObj = TenantSaveCodeInterface.beforeData(params);
		}

		return rObj;
	},

	beforeExecute: function(queryParams, qType) {
		//custom code here

		if (TenantSaveCodeInterface && TenantSaveCodeInterface.beforeExecute) {
			queryParams = TenantSaveCodeInterface.beforeExecute(queryParams, qType);
		}
		return queryParams;
	},

	afterData: function(saveCodeData) {


		if (TenantSaveCodeInterface && TenantSaveCodeInterface.afterData) {
			saveCodeData = TenantSaveCodeInterface.afterData(saveCodeData);
		}
		return saveCodeData;
	},

	onError: function(errorObj) {

		if (TenantSaveCodeInterface && TenantSaveCodeInterface.onError) {
			errorObj = TenantSaveCodeInterface.onError(errorObj);
		}
		return errorObj;
	}
};

function _formatArrForInQuery(arr) {
	var result = [];
	for (var i = 0; i < arr.length; i++) {
		result.push("'" + arr[i] + "'");
	}
	return "(" + result.join(", ") + ")";
}

function normalize(val) {
	if (typeof val !== "string") return "";
	return val.toLowerCase().replace(/\s+/g, "");
}

// Helper to prevent adding duplicates to the referenced array
function _addToDeletedRef(id, sourceArr, targetArr) {
	// Check if already in target
	for(var t=0; t<targetArr.length; t++) {
		if(targetArr[t].id == id) return;
	}
	// Find in source and add
	for(var s=0; s<sourceArr.length; s++) {
		if(sourceArr[s].id == id) {
			targetArr.push(sourceArr[s]);
			break;
		}
	}
}
