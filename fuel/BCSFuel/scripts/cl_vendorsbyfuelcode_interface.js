/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Wed Jan 28 2026 18:40:04 GMT+0530 (India Standard Time)
	Description : Combine Master Ui Interface for Vendor
	WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS
*/

var areMastersLoaded = false;

if (typeof TenantVendorInterface === 'undefined')
	TenantVendorInterface = {};

var VendorInterface = {
	onLoad: function() {

		document.querySelector("title").innerHTML = "BCS Fuel";
		document.querySelector("span").innerHTML = "BCS Fuel";

		if (TenantVendorInterface && TenantVendorInterface.onLoad)
			return TenantVendorInterface.onLoad();

	},

	onBeforeLoad: function() {
		//Custom code goes here

		if (areMastersLoaded) {
			return true;
		}

		clCommon.showLoader("listProgress");

		Promise.all([
			getAllVendorsPromise(),
			getAllCodePromise(),
			//getAllBusinessPartnerPromise(),
			getAllUnitPromise()
		]).then(function() {
			areMastersLoaded = true;
			loadVendorData();
		}).catch(function(err) {
			s_error(Strings.ERROR_TITLE, Strings.ERROR_LOAD_VENDOR, dlgOptions);
			clCommon.hideLoader("listProgress");
		});

		//return false;
		if (TenantVendorInterface && TenantVendorInterface.onBeforeLoad)
			return TenantVendorInterface.onBeforeLoad();
		return false;
	},

	onAfterLoad: function(isSuccessful, dataArr) {
		//custom code goes here

		var sheetData = editorSheet.getData();
		var predefinedCols = ["A", "B", "C", "D"];
		var setCols = [2];  //set the col to hide

		for (var row = 0; row < sheetData.length; row++) {
			var newRow = row + 1;

			for (var idx = 0; idx < setCols.length; idx++) {
				var checkCol = setCols[idx];
				var cellName = predefinedCols[checkCol] + newRow; 
				var newCell = editorSheet.getCell(cellName);

				if (newCell) {
					newCell.classList.add("readonly");
					newCell.setAttribute("contenteditable", "false");
					newCell.style.backgroundColor = "#f2f2f2";
					newCell.style.color = "#718096";
				}
			}
		}


		if (TenantVendorInterface && TenantVendorInterface.onAfterLoad)
			return TenantVendorInterface.onAfterLoad(isSuccessful, dataArr);
		return dataArr;
	},

	onBeforeData: function(svcName, params) {
		//custom code goes here

		if (TenantVendorInterface && TenantVendorInterface.onBeforeData)
			return TenantVendorInterface.onBeforeData(svcName, params);
		return params;
	},

	onAfterData: function(svcName, dataSources) {
		//custom code goes here

		if (TenantVendorInterface && TenantVendorInterface.onAfterData)
			return TenantVendorInterface.onAfterData(svcName, dataSources);
		return dataSources;
	},

	onBeforeSave: function(dataObj) {
		//custom code here

		if (!customValidate()) {
			return false;
		}

		if(!checkIsactive(dataObj)){
			return false;
		}

		if (TenantVendorInterface && TenantVendorInterface.onBeforeSave)
			return TenantVendorInterface.onBeforeSave(dataObj);
		return dataObj;
	},


	onAfterSave: function(isSuccessful, dataObj) {
		//Custom code here

		if (isSuccessful && dataObj.master_data) {
			try {
				var savedRows = JSON.parse(dataObj.master_data);
				if (savedRows && savedRows.length > 0) {
					for (var i = 0; i < savedRows.length; i++) {
						var rowData = savedRows[i];
						var rowNum = i + 1;
						editorSheet.setValue('A' + rowNum, rowData.id, true);
					}
				}
			} catch (e) {
				//console.error("Error updating IDs after save:", e);
			}
		}

		if (dataObj.err_code === 422) {

			if (dataObj.refFlag === true) {

				let alertText = '<p>' + Strings.FOREIGN_REFERENCE_EXIST_ON_VENDOR;
				let refLabels = [];

				if (dataObj.conflictSources) {

					if (dataObj.conflictSources.purchase)
						refLabels.push(Strings.REF_PURCHASE);
				}

				if (refLabels.length) {
					alertText += ' ' + refLabels.join(', ');
				}

				alertText += '</p>';
				alertText += '<p>such as:</p>';
				alertText += '<ol class="vendor_prompt_error">';

				dataObj.deletedWithRefArr.forEach(item => {
					const vendor = dataSources.getAllBusinessPartner.find(bp => bp._sid === item.fuel_vendor_id);

					if (vendor) {
						alertText += `<li>${vendor.name}</li>`;
					}
				});

				alertText += '</ol>';

				s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
			}

			// Soft-duplicate case
			if (dataObj.deletedDup === true && dataObj.refFlag === false) {
				s_toast(Strings.SAVE_VENDOR_TOAST_SUCCESS);
			}

			// Clear and rewrite sheet
			clearSheet();

			for (var i = 0; i < dataObj.data.length; i++) {
				var rowObj = dataObj.data[i];
				var rowId = i + 1;

				editorSheet.setValue('A' + rowId, rowObj.id, true);
				editorSheet.setValue('B' + rowId, rowObj.fuel_code_id, true);
				editorSheet.setValue('C' + rowId, rowObj.fuel_unit_id, true);
				editorSheet.setValue('D' + rowId, rowObj.fuel_vendor_id, true);
			}

			return false;
		}

		// Remove stale tooltips
		document.querySelectorAll('.jexcel td[title]').forEach(cell => {
			cell.removeAttribute('title');
		});


		if (TenantVendorInterface && TenantVendorInterface.onAfterSave)
			return TenantVendorInterface.onAfterSave(isSuccessful, dataObj);
		return dataObj;
	},

	onSheetChanged: function(instance, cell, col, row, value) {

		if (col === 1 || col === "1") {
			updateUnitByCode(row, value);
		}

		var sheetData = editorSheet.getData();
		var countMap = {};
		for (var r = 0; r < sheetData.length; r++) {
			var code = sheetData[r][1];   // Fuel Code
			var unit = sheetData[r][2];   // Unit
			var vendor = sheetData[r][3]; // Vendor


			if (code && vendor && unit) {
				var key = code + "###" + vendor + "###" + unit;

				if (!countMap[key]) {
					countMap[key] = 0;
				}
				countMap[key]++;
			}
		}

		//Apply/Remove Colors
		for (var r = 0; r < sheetData.length; r++) {
			var rowId = r + 1; 
			var code = sheetData[r][1];
			var unit = sheetData[r][2];
			var vendor = sheetData[r][3];


			var cellCode = instance.jspreadsheet.getCell('B' + rowId);
			var cellUnit = instance.jspreadsheet.getCell('C' + rowId);
			var cellVendor = instance.jspreadsheet.getCell('D' + rowId);


			if (code && vendor && unit) {
				var key = code + "###" + vendor + "###" + unit;
				if (countMap[key] > 1) {
					var errTitle = Strings.DUPLICATE_VENDOR_MAPPING || "Duplicate Combination";

					if (cellCode) { VendorInterface._addErrColor(cellCode); cellCode.setAttribute("title", errTitle); }
					if (cellVendor) { VendorInterface._addErrColor(cellVendor); cellVendor.setAttribute("title", errTitle); }
					if (cellUnit) { VendorInterface._addErrColor(cellUnit); cellUnit.setAttribute("title", errTitle); }
				} 
				else {
					if (cellCode) { VendorInterface._removeErrColor(cellCode); cellCode.removeAttribute("title"); }
					if (cellVendor) { VendorInterface._removeErrColor(cellVendor); cellVendor.removeAttribute("title"); }
					if (cellUnit) { VendorInterface._removeErrColor(cellUnit); cellUnit.removeAttribute("title"); }
				}
			} else {
				if (cellCode) VendorInterface._removeErrColor(cellCode);
				if (cellVendor) VendorInterface._removeErrColor(cellVendor);
				if (cellUnit) VendorInterface._removeErrColor(cellUnit);
			}
		}

		if (TenantVendorInterface && TenantVendorInterface.onSheetChanged)
			return TenantVendorInterface.onSheetChanged(instance, cell, col, row, value);
		return true;
	},

	_addErrColor: function(cell){
		cell.classList.add("error_value");
	},

	_removeErrColor: function(cell){
		cell.classList.remove("error_value");
	},
};

function updateUnitByCode( row, codeId) {

	if (!codeId || !dataSources || !dataSources.getAllCode) {
		return;
	}

	// Find selected code
	var selectedCode = null;
	for (var i = 0; i < dataSources.getAllCode.length; i++) {
		if (dataSources.getAllCode[i].id === codeId) {
			selectedCode = dataSources.getAllCode[i];
			break;
		}
	}

	if (!selectedCode || !selectedCode.unit) {
		editorSheet.setValueFromCoords(2, row, "");
		editorSheet.options.columns[2].source = [];
		return;
	}

	// Find unit name
	var unitName = "";
	for (var j = 0; j < dataSources.unitName.length; j++) {
		if (dataSources.unitName[j].id === selectedCode.unit) {
			unitName = dataSources.unitName[j].name;
			break;
		}
	}

	// Update unit dropdown source
	editorSheet.options.columns[2].source = [{
		id: selectedCode.unit,
		name: unitName
	}];

	// Auto-fill unit cell
	editorSheet.setValue('C' + (Number(row)+1), selectedCode.unit, true);
}

function checkIsactive(dataObj) {
	var inactiveRows = [];
	var sheetData = editorSheet.getData();

	for (var row = 0; row < sheetData.length; row++) {
		var rawCodeId   = sheetData[row][1]; // Fuel Code
		var rawUnitId   = sheetData[row][2]; // Fuel Unit
		var rawVendorId = sheetData[row][3]; // Fuel Vendor


		if (!rawCodeId || !rawUnitId || !rawVendorId) continue;

		for (var venIdx = 0; venIdx < dataSources.vendorsShortName.length; venIdx++) {
			var vendor = dataSources.vendorsShortName[venIdx];

			if (
				rawVendorId == vendor.id &&
				vendor.isactive === false
			) {
				inactiveRows.push(row + 1); // spreadsheet row number
				break;
			}
		}
	}

	if (inactiveRows.length === 0) {
		return true;
	}
var msg = Strings.CONFIRM_INACTIVE_VENDOR +
    "<br>" +
    "Inactive vendor rows are:<br>" +
    "<ol><li>" +
    inactiveRows.map(r => "Row " + r).join("</li><li>") +
    "</li></ol>";


	s_confirm(Strings.CONFIRM, msg, {
		STR_YES: dlgOptions.STR_YES,
		STR_NO: dlgOptions.STR_NO,

		onYes: function () {
			dataObj.master_data = JSON.stringify(dataObj.master_data);
			clCommon.showLoader("listProgress");

			Service.saveVendor(dataObj, function (resultObj) {
				clCommon.hideLoader("listProgress");

				if (resultObj.code === 200) {
					s_toast(Strings.SAVE_VENDOR_TOAST_SUCCESS);
					return true;
				}
			});
		},

		onNo: function () {
			//return false;
		}
	});

	return false; // block execution until confirm decision

}

function customValidate() {
	var validateError = [];
	var duplicateMap = {};
	var sheetData = editorSheet.getData();
	for (var row = 0; row < sheetData.length; row++) {
		var rawCode = sheetData[row][1];   // Fuel Code Name/Ref
		var rawUnit = sheetData[row][2];   // Fuel Unit Name/Ref
		var rawVendor = sheetData[row][3]; // Fuel Vendor Name/Ref


		if (!rawCode || !rawVendor || !rawUnit) continue;

		var uniqueKey = [rawCode, rawVendor, rawUnit]
		.map(val => String(val).trim().toLowerCase().replace(/\s+/g, ""))
		.join("|");

		if (!duplicateMap[uniqueKey]) {
			duplicateMap[uniqueKey] = [row + 1];
		} else {
			duplicateMap[uniqueKey].push(row + 1);
		}
	}

	// Row-wise validation
	for (var row = 0; row < sheetData.length; row++) {
		var errorStr = "";

		function addError(error) {
			errorStr += error + "<br>";
		}

		var id = sheetData[row][0];
		var fuelCodeName = (sheetData[row][1] || "").toString().trim();
		var fuelUnitName = (sheetData[row][2] || "").toString().trim();
		var vendorName = (sheetData[row][3] || "").toString().trim();


		// Skip completely empty rows
		if (!id && !fuelCodeName && !vendorName && !fuelUnitName) {
			continue;
		}

		// Mandatory Field Validations 
		if (!fuelCodeName) {
			addError(Strings.FUEL_CODE_REQUIRED);
		}

		if (!vendorName) {
			addError(Strings.FUEL_VENDOR_REQUIRED);
		}

		if (!fuelUnitName) {
			addError(Strings.FUEL_UNIT_REQUIRED);
		}

		// Combination Uniqueness Validation
		if (fuelCodeName && vendorName && fuelUnitName) {
			var currentKey = [fuelCodeName, vendorName, fuelUnitName]
			.map(val => String(val).trim().toLowerCase().replace(/\s+/g, ""))
			.join("|");

			if (duplicateMap[currentKey] && duplicateMap[currentKey].length > 1) {
				addError(
					Strings.DUPLICATE_VENDOR_MAPPING + 
					" at rows " + duplicateMap[currentKey].join(", ")
				);
			}
		}


		if (errorStr !== "") {
			vendorName = clCommon.getDataByAttribute(dataSources.getAllBusinessPartner, "_sid", vendorName, "name");
			fuelCodeName = clCommon.getDataByAttribute(dataSources.getAllCode, "id", fuelCodeName,  "code");

			vendorName = vendorName? vendorName : "";
			fuelCodeName = fuelCodeName? fuelCodeName : "";

			validateError.push({
				row: row + 1,

				displayName: fuelCodeName + " / " + vendorName,
				error: errorStr
			});
		}
	}

	//Show validation popup
	if (validateError.length > 0) {
		var alertText = '<p>' + Strings.VALIDATE_VENDOR_PROMPT + '</p>';
		alertText += '<ol class="fuel_prompt_error">';

		validateError.forEach(function (errorObj) {
			alertText +=
				'<li>' + errorObj.displayName + '(Row ' + errorObj.row + ')<br>' +
				'<em>' + Strings.VALIDATION_ERROR + ':</em><br>' +
				errorObj.error +
				'</li><br>';
		});

		alertText += '</ol>';

		s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
		return false;
	}

	return true;
}

function getAllVendorsPromise() {
	return new Promise((resolve, reject) => {
		Service.getAllVendorsWithoutLimit(function (respObj) {
			if (respObj && respObj.code === 200) {
				var vendorsArr = respObj.data || [];
				dataSources = dataSources || {};

				// Store raw data
				dataSources.getAllVendorsWithoutLimit = vendorsArr;

				if (dataSources.getAllVendorsWithoutLimit.length > 1) {
					dataSources.getAllVendorsWithoutLimit = clCommon.sort(dataSources.getAllVendorsWithoutLimit, "business_partner_short_name");
				}

				dataSources.vendorsShortName = [];
				for (var t = 0; t < dataSources.getAllVendorsWithoutLimit.length; t++) {

					if(dataSources.getAllVendorsWithoutLimit[t].isactive == false){
						dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name += " - Inactive"
					}

					try {
						dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name = scrypto.decrypt(dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name);
					} catch (e) {
						dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name = dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name;
					}

					dataSources.vendorsShortName.push({
						"id": dataSources.getAllVendorsWithoutLimit[t]._sid,
						"name": dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name,
						"isactive" : dataSources.getAllVendorsWithoutLimit[t].isactive
					});
				}

				// Update JSpreadsheet Column
				if(editorSheet && editorSheet.options && editorSheet.options.columns) {
					editorSheet.options.columns[3].source = dataSources.vendorsShortName;
				}
				resolve();
			} else {
				resolve(); 
			}
		});
	});
}




function getAllBusinessPartnerPromise() {
	return new Promise((resolve, reject) => {
		Service.getAllBusinessPartner(function (respObj) {
			if (respObj && respObj.code === 200) {
				var businessPartnerArr = respObj.data || [];
				dataSources = dataSources || {};

				// Store raw data
				dataSources.getAllBusinessPartner = businessPartnerArr;

				if (dataSources.getAllBusinessPartner.length > 1) {
					dataSources.getAllBusinessPartner = clCommon.sort(dataSources.getAllBusinessPartner, "name");
				}

				// Transform for Dropdown
				dataSources.vendorName = [];
				for (var t = 0; t < dataSources.getAllBusinessPartner.length; t++) {
					try {
						dataSources.getAllBusinessPartner[t].name = scrypto.decrypt(dataSources.getAllBusinessPartner[t].name);
					} catch (e) {
						// keep original if decrypt fails
					}
					dataSources.vendorName.push({
						"id": dataSources.getAllBusinessPartner[t]._sid,
						"name": dataSources.getAllBusinessPartner[t].name
					});
				}

				// Update JSpreadsheet Column
				if(editorSheet && editorSheet.options && editorSheet.options.columns) {
					editorSheet.options.columns[3].source = dataSources.vendorName;
				}
				resolve();
			} else {
				resolve(); 
			}
		});
	});
}

function getAllUnitPromise() {
	return new Promise((resolve, reject) => {
		Service.getUnit(function (resultObj) {
			if (resultObj && resultObj.code === 200) {
				var unitArr = resultObj.data || [];
				dataSources = dataSources || {};
				dataSources.getAllUnit = JSON.parse(unitArr[0].master_data);

				if (dataSources.getAllUnit && dataSources.getAllUnit.length > 1) {
					dataSources.getAllUnit = clCommon.sort(dataSources.getAllUnit, "unit");
				}

				dataSources.unitName = [];
				for (var t = 0; t < dataSources.getAllUnit.length; t++) {
					try {
						dataSources.getAllUnit[t].unit = scrypto.decrypt(dataSources.getAllUnit[t].unit);
					} catch (e) {}
					dataSources.unitName.push({
						"id": dataSources.getAllUnit[t].id,
						"name": dataSources.getAllUnit[t].unit
					});
				}

				if(editorSheet && editorSheet.options && editorSheet.options.columns) {
					editorSheet.options.columns[2].source = dataSources.unitName;
				}


				resolve();
			} else {
				resolve();
			}
		});
	});
}

function getAllCodePromise() {
	return new Promise((resolve, reject) => {
		Service.getCode(function (resultObj) {
			if (resultObj && resultObj.code === 200) {
				var codeArr = resultObj.data || [];
				dataSources = dataSources || {};
				dataSources.getAllCode = JSON.parse(codeArr[0].master_data);

				if (dataSources.getAllCode && dataSources.getAllCode.length > 1) {
					dataSources.getAllCode = clCommon.sort(dataSources.getAllCode, "code");
				}

				dataSources.codeName = [];
				for (var t = 0; t < dataSources.getAllCode.length; t++) {
					try {
						dataSources.getAllCode[t].code = scrypto.decrypt(dataSources.getAllCode[t].code);
					} catch (e) {}
					dataSources.codeName.push({
						"id": dataSources.getAllCode[t].id,
						"name": dataSources.getAllCode[t].code
					});
				}

				if(editorSheet && editorSheet.options && editorSheet.options.columns) {
					editorSheet.options.columns[1].source = dataSources.codeName;
				}
				resolve();
			} else {
				resolve();
			}
		});
	});
}


