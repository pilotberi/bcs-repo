/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Tue Jan 27 2026 16:44:07 GMT+0530 (India Standard Time)
	Description : Combine Master Ui Interface for unit
	WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS
*/

if (typeof TenantUnitInterface === 'undefined')
	TenantUnitInterface = {};

var UnitInterface = {
	onLoad: function() {

		document.querySelector("title").innerHTML = "BCS Fuel";
		document.querySelector("span").innerHTML = "BCS Fuel";

		if (TenantUnitInterface && TenantUnitInterface.onLoad)
			return TenantUnitInterface.onLoad();

	},

	onBeforeLoad: function() {
		//Custom code goes here


		if (TenantUnitInterface && TenantUnitInterface.onBeforeLoad)
			return TenantUnitInterface.onBeforeLoad();
		return true;
	},

	onAfterLoad: function(isSuccessful, dataArr) {
		//custom code goes here
		UnitInterface.loaded = true;

		if (TenantUnitInterface && TenantUnitInterface.onAfterLoad)
			return TenantUnitInterface.onAfterLoad(isSuccessful, dataArr);
		return dataArr;
	},

	onBeforeData: function(svcName, params) {
		//custom code goes here

		if (TenantUnitInterface && TenantUnitInterface.onBeforeData)
			return TenantUnitInterface.onBeforeData(svcName, params);
		return params;
	},

	onAfterData: function(svcName, dataSources) {
		//custom code goes here

		if (TenantUnitInterface && TenantUnitInterface.onAfterData)
			return TenantUnitInterface.onAfterData(svcName, dataSources);
		return dataSources;
	},

	onBeforeSave: function(dataObj) {
		//custom code here
		if(!customValidate(dataObj)){
			return false
		}
		const sheetData = editorSheet.getData();

		for (let row = 0; row < sheetData.length; row++) {

			// remove description if id or value is not available
			const col0Empty = !sheetData[row][0] || sheetData[row][0].trim() === "";
			const col1Empty = !sheetData[row][1] || sheetData[row][1].trim() === "";

			if (col0Empty && col1Empty) {
				editorSheet.setValueFromCoords(2, row, "");
			}
		}


		/*// check duplicate unit
		if (dataObj.master_data.length !== 0) {

			const sheetData = editorSheet.getData();
			let invalidDescRows = [];
			let invalidUnitRows = [];


			for (let row = 0; row < sheetData.length; row++) {

				const unit = sheetData[row][1];
				const description = sheetData[row][2];


				// remove description if id or value is not available
				const col0Empty = !sheetData[row][0] || sheetData[row][0].trim() === "";
				const col1Empty = !sheetData[row][1] || sheetData[row][1].trim() === "";

				if (col0Empty && col1Empty) {
					editorSheet.setValueFromCoords(2, row, "");
				}

				if (description && description.length > 25) {
					invalidDescRows.push(row + 1);
				}

				if (unit && unit.length > 10) {
					invalidUnitRows.push(row + 1);
				}
			}

			var duplicates = common_util.checkDuplicate(sheetData, editorSheet);
			duplicates = duplicates.duplicates;

			if (duplicates.size > 0) {

				let alertText = '<p>' + Strings.DUPLICATE_UNIT_ERROR_1 + '</p>';
				alertText += '<ol class="unit_prompt_error">';

				duplicates.forEach((rows, Unit) => {
					alertText += '<li>' + 	"'"+Unit+"'" + ' ' + Strings.DUPLICATE_UNIT_ERROR_2 + ' ' + rows.join(", ") + '</li>';
				});

				alertText += '</ol>';

				s_info( Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions );
				return false;
			}

			if (invalidDescRows.length > 0) {
				let alertText = '<p>' + Strings.UNIT_DESC_VALIDATION_ERR;
				alertText += ' at rows ' + invalidDescRows.join(', ');
				alertText += '</p>';

				s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
				return false;
			}

			if (invalidUnitRows.length > 0) {
				let alertText = '<p>' + Strings.UNIT_VALIDATION_ERR;
				alertText += ' at rows ' + invalidUnitRows.join(', ');
				alertText += '</p>';

				s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
				return false;
			}
		}*/

		if (TenantUnitInterface && TenantUnitInterface.onBeforeSave)
			return TenantUnitInterface.onBeforeSave(dataObj);
		return dataObj;
	},

	onAfterSave: function (isSuccessful, dataObj) {
		// Custom code here

		if (isSuccessful && dataObj.master_data) {
			try {
				var savedRows = JSON.parse(dataObj.master_data);
				if (savedRows && savedRows.length > 0) {
					for (var i = 0; i < savedRows.length; i++) {
						var rowData = savedRows[i];
						var rowNum = i + 1;
						editorSheet.setValue('A' + rowNum, rowData.id, true);
					}
				}
			} catch (e) {
				//console.error("Error updating IDs after save:", e);
			}
		}

		if (dataObj.err_code === 422) {

			if (dataObj.refFlag === true) {

				let alertText = '<p>' + Strings.FOREIGN_REFERENCE_EXIST_ON_UNIT;
				let refLabels = [];

				if (dataObj.conflictSources) {
					if (dataObj.conflictSources.code)
						refLabels.push(Strings.REF_CODE);

					if (dataObj.conflictSources.vendor)
						refLabels.push(Strings.REF_VENDOR);

					if (dataObj.conflictSources.utilization)
						refLabels.push(Strings.REF_UTILIZATION);

					if (dataObj.conflictSources.purchase)
						refLabels.push(Strings.REF_PURCHASE);

					if (dataObj.conflictSources.consumption)
						refLabels.push(Strings.REF_CONSUMPTION);

					if (dataObj.conflictSources.loss)
						refLabels.push(Strings.REF_LOSS);
				}

				if (refLabels.length) {
					alertText += ' ' + refLabels.join(', ');
				}

				alertText += '</p>';
				alertText += '<p>such as:</p>';
				alertText += '<ol class="unit_prompt_error">';

				dataObj.deletedWithRefArr.forEach(item => {
					alertText += '<li>' + item.unit + '</li>';
				});

				alertText += '</ol>';

				s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
			}

			if (dataObj.deletedDup === true && dataObj.refFlag === false) {
				s_toast(Strings.SAVE_UNIT_TOAST_SUCCESS);
			}

			clearSheet();

			for (var i = 0; i < dataObj.data.length; i++) {
				var rowId = i + 1;
				var rowObj = dataObj.data[i];

				editorSheet.setValue('A' + rowId, rowObj.id, true);
				editorSheet.setValue('B' + rowId, rowObj.unit, true);
				editorSheet.setValue('C' + rowId, rowObj.description, true);
			}

			return false;
		}

		document.querySelectorAll('.jexcel td[title]').forEach(cell => {
			cell.removeAttribute('title');
		});

		if (TenantUnitInterface && TenantUnitInterface.onAfterSave)
			return TenantUnitInterface.onAfterSave(isSuccessful, dataObj);
		return dataObj;
	},

	onSheetChanged: function(instance, cell, col, row, value) {
		//Custom code here

		if(UnitInterface.loaded ){
			const sheetData = editorSheet.getData();
			const cellId = Number(row) + 1;
			const targetUnitCell = instance.jspreadsheet.getCell(`B${String(cellId)}`);
			const targetDescriptionCell = instance.jspreadsheet.getCell(`C${String(cellId)}`);

			//validation
			if(value && value.length > 10 && (col === 1 || col === "1")){
				UnitInterface._addErrColor(cell);
				cell.setAttribute("title", Strings.UNIT_VALIDATION_ERR);
				return false;
			}

			if(value && value.length > 25 && (col === 2 || col === "2")){
				UnitInterface._addErrColor(cell);
				cell.setAttribute("title", Strings.UNIT_DESC_VALIDATION_ERR);
				return false;
			}

			if (targetDescriptionCell) {
				const unitValue = sheetData[row][1];
				const descValue = sheetData[row][2] || "";

				const descTooLong = descValue.length > 25;
				const descWithoutUnit = descValue && (!unitValue || unitValue.trim() === "");

				if (descTooLong) {
					UnitInterface._addErrColor(targetDescriptionCell);
					targetDescriptionCell.setAttribute("title",Strings.UNIT_DESC_VALIDATION_ERR);
				}else if (descWithoutUnit) {
					UnitInterface._addErrColor(targetDescriptionCell);
					targetDescriptionCell.setAttribute("title","Description with no Unit");
				}
				else {
					UnitInterface._removeErrColor(targetDescriptionCell);
					targetDescriptionCell.removeAttribute("title");
				}
			}

			var duplicateResults = common_util.checkDuplicate(sheetData, editorSheet);
			var duplicates = duplicateResults.duplicates;

			//remove color non duplicate unit
			if (duplicates.size === 0) {
				for (let idx = 1; idx <= sheetData.length; idx++) {
					const unitValue = sheetData[idx - 1][1];
					const unitCell = instance.jspreadsheet.getCell(`B${idx}`);

					if (unitCell) {
						if (!unitValue || unitValue.length <= 10) {
							UnitInterface._removeErrColor(unitCell);
							unitCell.removeAttribute("title");
						}
					}
				}
			}

			//add color for duplicate UNIT
			if (duplicates && duplicates.size > 0) {
				duplicates.forEach((rows, value) => {
					rows.forEach((row) => {
						const unitCell = instance.jspreadsheet.getCell(`B${row}`);
						if (unitCell) {
							UnitInterface._addErrColor(unitCell);
							unitCell.setAttribute("title","This data is already Exist");
						}
					});
				});
			}
		}

		if (TenantUnitInterface && TenantUnitInterface.onSheetChanged)
			return TenantUnitInterface.onSheetChanged(instance, cell, col, row, value);
		return true;
	},
	_addErrColor: function(cell){
		cell.classList.add("error_value");
	},

	_removeErrColor: function(cell){
		cell.classList.remove("error_value");
	},
};


function customValidate() {

	var validateError = [];
	var duplicateMap = {};
	var sheetData = editorSheet.getData();

	// Build duplicate map (Fuel Unit â†’ rows)
	for (var row = 0; row < sheetData.length; row++) {

		var rawUnit = sheetData[row][1];
		if (!rawUnit || rawUnit.trim() === "") continue;

		var normalizedUnit = String(rawUnit)
		.trim()
		.toLowerCase()
		.replace(/\s+/g, "");

		if (!duplicateMap[normalizedUnit]) {
			duplicateMap[normalizedUnit] = [row + 1];
		} else {
			duplicateMap[normalizedUnit].push(row + 1);
		}
	}

	// Row-wise validation
	for (var row = 0; row < sheetData.length; row++) {

		var errorStr = "";

		function addError(error) {
			errorStr += error + "<br>";
		}

		var id = sheetData[row][0];
		var unitRaw = sheetData[row][1];
		var description = (sheetData[row][2] || "").trim();

		// Normalize Fuel Unit
		var unit = unitRaw
		? String(unitRaw).trim().toLowerCase().replace(/\s+/g, "")
		: "";

		// Skip completely empty rows
		if (!id && !unit && !description) {
			continue;
		}
		
		if(!unit && description){
			addError(Strings.FUEL_UNIT_REQUIRED)
		}

		// Fuel Unit validation
		if (unit ){

			if (unit.length > 10) {
				addError(Strings.UNIT_LENGTH_ERROR);
			}

			if (
				duplicateMap[unit] &&
				duplicateMap[unit].length > 1
			) {
				addError(
					Strings.UNIT_DUPLICATE +
					" at rows " +
					duplicateMap[unit].join(", ")
				);
			}
		}

		// Description validation
		if (description && description.length > 25) {
			addError(Strings.UNIT_DESCRIPTION_LENGTH_ERROR);
		}

		if (errorStr !== "") {
			validateError.push({
				row: row + 1,
				code: unit || "-",
				error: errorStr
			});
		}
	}

	// Show validation popup
	if (validateError.length > 0) {

		var alertText = '<p>' + Strings.VALIDATE_UNIT_PROMPT + '</p>';
		alertText += '<ol class="yard_prompt_error">';

		validateError.forEach(function (errorObj) {
			alertText +=
				'<li>' +
				Strings.FUEL_UNIT + ': ' + errorObj.code +
				' (Row ' + errorObj.row + ')<br>' +
				Strings.VALIDATION_ERROR + ':<br>' +
				errorObj.error +
				'</li><br>';
		});

		alertText += '</ol>';

		s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
		return false;
	}

	return true;
}
