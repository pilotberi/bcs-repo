/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Wed Jan 28 2026 10:45:55 GMT+0530 (India Standard Time)
	Description : Combine Master Ui Interface for code
	WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS
*/

if (typeof TenantCodeInterface === 'undefined')
	TenantCodeInterface = {};

var CodeInterface = {
	onLoad: function() {

		document.querySelector("title").innerHTML = "BCS Fuel";
		document.querySelector("span").innerHTML = "BCS Fuel";

		getAllUnitPromise();
		dataSources.gstApplicable = [{"id":"yes","name":"Yes"},{"id":"no","name":"No"}];
		dataSources.gstRate = [{"id":"5","name":"5% "},{"id":"12","name":"12%"},{"id":"18","name":"18%"}];

		//customValidate = validate;

		if (TenantCodeInterface && TenantCodeInterface.onLoad)
			return TenantCodeInterface.onLoad();

	},

	onBeforeLoad: function() {
		//Custom code goes here


		if (TenantCodeInterface && TenantCodeInterface.onBeforeLoad)
			return TenantCodeInterface.onBeforeLoad();
		return true;
	},

	onAfterLoad: function(isSuccessful, dataArr) {
		//custom code goes here
		CodeInterface.loaded = true;

		if (TenantCodeInterface && TenantCodeInterface.onAfterLoad)
			return TenantCodeInterface.onAfterLoad(isSuccessful, dataArr);
		return dataArr;
	},

	onBeforeData: function(svcName, params) {
		//custom code goes here

		if (TenantCodeInterface && TenantCodeInterface.onBeforeData)
			return TenantCodeInterface.onBeforeData(svcName, params);
		return params;
	},

	onAfterData: function(svcName, dataSources) {
		//custom code goes here

		if (TenantCodeInterface && TenantCodeInterface.onAfterData)
			return TenantCodeInterface.onAfterData(svcName, dataSources);
		return dataSources;
	},

	onBeforeSave: function(dataObj) {
		//custom code here

		if(!customValidate(dataObj)){
			return false
		}
		const sheetData = editorSheet.getData();

		for (let row = 0; row < sheetData.length; row++) {

			// remove description if id or value is not available
			const col0Empty = !sheetData[row][0] || sheetData[row][0].trim() === "";
			const col1Empty = !sheetData[row][1] || sheetData[row][1].trim() === "";

			if (col0Empty && col1Empty) {
				editorSheet.setValueFromCoords(2, row, "");
			}
		}

		if (TenantCodeInterface && TenantCodeInterface.onBeforeSave)
			return TenantCodeInterface.onBeforeSave(dataObj);
		return dataObj;
	},

	onAfterSave: function(isSuccessful, dataObj) {
		//Custom code here

		if (isSuccessful && dataObj.master_data) {
			try {
				var savedRows = JSON.parse(dataObj.master_data);
				if (savedRows && savedRows.length > 0) {
					for (var i = 0; i < savedRows.length; i++) {
						var rowData = savedRows[i];
						var rowNum = i + 1;
						editorSheet.setValue('A' + rowNum, rowData.id, true);
					}
				}
			} catch (e) {
				//console.error("Error updating IDs after save:", e);
			}
		}


		if(dataObj.err_code === 422){

			if (dataObj.refFlag === true) {

				let alertText = '<p>' + Strings.FOREIGN_REFERENCE_EXIST_ON_FUEL_CODE;
				let refLabels = [];

				if (dataObj.conflictSources) {

					if (dataObj.conflictSources.vendor)
						refLabels.push(Strings.REF_VENDOR);

					if (dataObj.conflictSources.utilization)
						refLabels.push(Strings.REF_UTILIZATION);

					if (dataObj.conflictSources.purchase)
						refLabels.push(Strings.REF_PURCHASE);

					if (dataObj.conflictSources.consumption)
						refLabels.push(Strings.REF_CONSUMPTION);

					if (dataObj.conflictSources.loss)
						refLabels.push(Strings.REF_LOSS);
				}

				if (refLabels.length) {
					alertText += ' ' + refLabels.join(', ');
				}

				alertText += '</p>';
				alertText += '<p>such as:</p>';
				alertText += '<ol class="fuelcode_prompt_error">';

				dataObj.deletedWithRefArr.forEach(item => {
					alertText += '<li>' + item.code + '</li>';
				});

				alertText += '</ol>';

				s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
			}

			if(dataObj.deletedDup === true && dataObj.refFlag === false ){
				s_toast(Strings.SAVE_CODE_TOAST_SUCCESS);
			}

			clearSheet();

			//rewright the sheet
			for (var i = 0; i < dataObj.data.length; i++) {
				var rowObj = dataObj.data[i];
				var rowId = i + 1;

				editorSheet.setValue('A' + rowId, rowObj.id, true);
				editorSheet.setValue('B' + rowId, rowObj.code, true);
				editorSheet.setValue('C' + rowId, rowObj.unit, true);
				editorSheet.setValue('D' + rowId, rowObj.description, true);
				editorSheet.setValue('E' + rowId, rowObj.gst_applicable, true);
				editorSheet.setValue('F' + rowId, rowObj.gst_rate, true);
			}
			return false;
		}

		document.querySelectorAll('.jexcel td[title]').forEach(cell => {
			cell.removeAttribute('title');
		});


		if (TenantCodeInterface && TenantCodeInterface.onAfterSave)
			return TenantCodeInterface.onAfterSave(isSuccessful, dataObj);
		return dataObj;
	},

	onSheetChanged: function(instance, cell, col, row, value) {
		//Custom code here

		if(CodeInterface.loaded ){
			const sheetData = editorSheet.getData();
			const cellId = Number(row) + 1;
			const targetCodeCell = instance.jspreadsheet.getCell(`B${String(cellId)}`);
			const targetDescriptionCell = instance.jspreadsheet.getCell(`D${String(cellId)}`);

			//validation
			if(value && value.length > 30 && (col === 1 || col === "1")){
				CodeInterface._addErrColor(cell);
				cell.setAttribute("title", Strings.CODE_VALIDATION_ERR);
				return false;
			}

			if(value && value.length > 50 && (col === 3 || col === "3")){
				CodeInterface._addErrColor(cell);
				cell.setAttribute("title", Strings.CODE_DESC_VALIDATION_ERR);
				return false;
			}

			if (targetDescriptionCell) {

				const codeValue = sheetData[row][1];
				const descValue = sheetData[row][3] || "";

				const descTooLong = descValue.length > 50;
				const descWithoutCode = descValue && (!codeValue || codeValue.trim() === "");

				if (descTooLong) {
					CodeInterface._addErrColor(targetDescriptionCell);
					targetDescriptionCell.setAttribute("title",Strings.CODE_DESC_VALIDATION_ERR);
				}
				else if (descWithoutCode) {
					CodeInterface._addErrColor(targetDescriptionCell);
					targetDescriptionCell.setAttribute("title","Description with no Code");
				}
				else {
					CodeInterface._removeErrColor(targetDescriptionCell);
					targetDescriptionCell.removeAttribute("title");
				}
			}


			var duplicateResults = common_util.checkDuplicate(sheetData, editorSheet);
			var duplicates = duplicateResults.duplicates;

			//remove color non duplicate code
			if (duplicates.size === 0) {
				for (let idx = 1; idx <= sheetData.length; idx++) {
					const codeValue = sheetData[idx - 1][1];
					const codeCell = instance.jspreadsheet.getCell(`B${idx}`);

					if (codeCell) {
						if (!codeValue || codeValue.length <= 30) {
							CodeInterface._removeErrColor(codeCell);
							codeCell.removeAttribute("title");
						}
					}
				}
			}

			//add color for duplicate code
			if (duplicates && duplicates.size > 0) {
				duplicates.forEach((rows, value) => {
					rows.forEach((row) => {
						const codeCell = instance.jspreadsheet.getCell(`B${row}`);
						if (codeCell) {
							CodeInterface._addErrColor(codeCell);
							codeCell.setAttribute("title","This data is already Exist");
						}
					});
				});
			}

			//remove rate when GST applicable is no
			if (col === 4 || col === "4" && String(value).toLowerCase() === "no") {
				editorSheet.setValueFromCoords(5, row, "");
			}

		}


		if (TenantCodeInterface && TenantCodeInterface.onSheetChanged)
			return TenantCodeInterface.onSheetChanged(instance, cell, col, row, value);
		return true;
	},
	_addErrColor: function(cell){
		cell.classList.add("error_value");
	},

	_removeErrColor: function(cell){
		cell.classList.remove("error_value");
	},
};

function getAllUnitPromise() {
	return Service.getUnit(function (respObj) {
		if (respObj && respObj.code === 200) {
			var unitArr = respObj.data || [];
			dataSources = dataSources || {};

			// Store raw data
			dataSources.getAllUnit = JSON.parse(unitArr[0].master_data);

			if (dataSources.getAllUnit.length > 1) {
				dataSources.getAllUnit = clCommon.sort(dataSources.getAllUnit, "name");
			}

			for (var t = 0; t < dataSources.getAllUnit.length; t++) {
				try {
					dataSources.getAllUnit[t].name = scrypto.decrypt(
						dataSources.getAllUnit[t].unit
					);
				} catch (e) {
					dataSources.getAllUnit[t].name = dataSources.getAllUnit[t].unit;
				}
			}

			if(editorSheet && editorSheet.options && editorSheet.options.columns) {
				editorSheet.options.columns[2].source = dataSources.getAllUnit;
			}
		}
	});
}


function customValidate() {

	var validateError = [];
	var duplicateMap = {};
	var sheetData = editorSheet.getData();


	//Build duplicate map (Fuel Code â†’ rows)

	for (var row = 0; row < sheetData.length; row++) {

		var rawCode = sheetData[row][1];
		if (!rawCode || rawCode.trim() === "") continue;

		var normalizedCode = String(rawCode)
		.trim()
		.toLowerCase()
		.replace(/\s+/g, "");

		if (!duplicateMap[normalizedCode]) {
			duplicateMap[normalizedCode] = [row + 1];
		} else {
			duplicateMap[normalizedCode].push(row + 1);
		}
	}

	//Row-wise validation
	for (var row = 0; row < sheetData.length; row++) {

		var errorStr = "";

		function addError(error) {
			errorStr += error + "<br>";
		}

		var id = sheetData[row][0];
		var fuelCodeRaw = sheetData[row][1];
		var fuelUnitRaw = sheetData[row][2];
		var description = (sheetData[row][3] || "").trim();
		var gstApplicable = (sheetData[row][4] || "").trim().toLowerCase();
		var gstRate = (sheetData[row][5] || "").trim();

		// Normalize fuel code
		var fuelCode = fuelCodeRaw? String(fuelCodeRaw).trim().toLowerCase().replace(/\s+/g, ""): "";

		// Skip completely empty rows
		if (!id && !fuelUnitRaw && !fuelCode && !description && !gstApplicable && !gstRate) {
			continue;
		}

		// Fuel Code validations 
		if (!fuelCode) {
			addError(Strings.FUEL_CODE_REQUIRED);
		} else {
			if (fuelCode.length > 30) {
				addError(Strings.FUEL_CODE_LENGTH_ERROR);
			}

			if (duplicateMap[fuelCode] && duplicateMap[fuelCode].length > 1 ) {
				addError(Strings.FUEL_CODE_DUPLICATE + " at rows " + duplicateMap[fuelCode].join(", "));
			}
		}

		// Fuel unit validations 
		if (!fuelUnitRaw) {
			addError(Strings.FUEL_UNIT_REQUIRED);
		}

		//Description validation 
		if (description && description.length > 50) {
			addError(Strings.FUEL_DESCRIPTION_LENGTH_ERROR);
		}

		// GST Applicable validation 
		if (!gstApplicable) {
			addError(Strings.GST_APPLICABLE_REQUIRED);
		} else if (gstApplicable !== "yes" && gstApplicable !== "no") {
			addError(Strings.GST_APPLICABLE_INVALID);
		}

		// GST Rate validation 
		if (gstApplicable === "yes" && !gstRate) {
			addError(Strings.GST_RATE_REQUIRED);
		}

		if (errorStr !== "") {
			validateError.push({
				row: row + 1,
				code: fuelCode || "-",
				error: errorStr
			});
		}
	}

	// Show validation popup
	if (validateError.length > 0) {

		var alertText = '<p>' + Strings.VALIDATE_FUEL_PROMPT + '</p>';
		alertText += '<ol class="fuel_prompt_error">';

		validateError.forEach(function (errorObj) {
			alertText +=
				'<li>' +
				Strings.FUEL_CODE + ': ' + errorObj.code +
				' (Row ' + errorObj.row + ')<br>' +
				Strings.VALIDATION_ERROR + ':<br>' +
				errorObj.error +
				'</li><br>';
		});

		alertText += '</ol>';

		s_info(Strings.VALIDATION_ERROR_TITLE, alertText, dlgOptions);
		return false;
	}

	return true;
}
