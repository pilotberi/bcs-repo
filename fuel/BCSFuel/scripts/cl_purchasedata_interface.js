/*
			Generated By : Steps Code Generator.
			Version : 2024
			Generated On : Thu Jan 29 2026 18:26:47 GMT+0530 (India Standard Time)
			Description : Interface Logic for BCSFuel List Details.
			WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS.
			Custom code can be writter here.
			Use customDtOpns object to maniuplate data table.
		*/

var mSelect,ySelect;
var filterMSelect, filterYSelect;
var previousCodeId;

if (typeof TenantPurchaseInterface === 'undefined')
	TenantPurchaseInterface = {};

var PurchaseInterface = {
	onLoad: function() {
		//Custom code goes here

		document.querySelector("title").innerHTML = "BCS Fuel";
		document.querySelector("span").innerHTML = "BCS Fuel";
		document.querySelector("#fuelCodeFilter option[value='all']").innerHTML = "All Fuel Code";

		clCommon.hide(document.getElementById("nav-action-tab"));
		clCommon.hide(document.getElementById("purchaseFuel_unit_idZoom"));

		convertDateToMonthYearPicker();
		mSelect = document.getElementById('purchase_date_monthSelect');
		ySelect = document.getElementById('purchase_date_yearSelect');

		createFilterMonthYearPicker();
		getAllVendorsPromise()
		//getAllBusinessPartnerPromise()




		if (TenantPurchaseInterface && TenantPurchaseInterface.onLoad)
			return TenantPurchaseInterface.onLoad();

		return true;
	},

	onBeforeLoad: function(dataSources) {

		clCommon.disable(purchaseTotal_fuel_value);
		clCommon.disable(purchaseUnit_price);
		clCommon.disable(purchaseFuel_gst_value);

		var dates = getCustomFilterDates();
		dataSources.startDate = dates.startDate;
		dataSources.endDate = dates.endDate;

		common_util.setFuelCodeCookie();


		if (TenantPurchaseInterface && TenantPurchaseInterface.onBeforeLoad)
			return TenantPurchaseInterface.onBeforeLoad();

		return dataSources;
	},

	onAfterLoad: function(dataSources) {


		clCommon.hide(fuel_code_idAddBtn);
		clCommon.hide(fuel_unit_idAddBtn);
		clCommon.hide(fuel_vendor_idAddBtn);

		if (formView.classList.contains("hide")) {
			if (clCommon.isMobile()) {
				clCommon.hide(filterActionsPurchaseBtn);
			}
		}

		/*var codeMap = {};
		if (dataSources.getCode) {
			dataSources.getCode.forEach(function (codeObj) {
				codeMap[codeObj.id] = codeObj.code;
			});
		}

		var unitMap = {};
		if (dataSources.getUnit) {
			dataSources.getUnit.forEach(function (unitObj) {
				unitMap[unitObj.id] = unitObj.unit;
			});
		}

		var partnerMap = {};
		if (dataSources.getAllBusinessPartner) {
			dataSources.getAllBusinessPartner.forEach(function (bpObj) {
				partnerMap[bpObj._sid] = bpObj.name;
			});
		}

		if (dataSources.getVendor) {
			dataSources.getVendor.forEach(function (vendorObj) {

				var code  = codeMap[vendorObj.fuel_code_id] || '';
				var name  = partnerMap[vendorObj.fuel_vendor_id] || '';
				var unit  = unitMap[vendorObj.fuel_unit_id] || '';

				var parts = [];
				if (code) parts.push(code);
				if (name) parts.push(name);
				if (unit) parts.push(unit);

				vendorObj.fuel_vendor_name = parts.join(' - ');
			});
		}*/


		/*if(dataSources.getAllBusinessPartner){
			for (var vendorIdx = 0; vendorIdx < dataSources.getVendor.length; vendorIdx++) {
				var vendorObj = dataSources.getVendor[vendorIdx];
				for (var customerIdx = 0; customerIdx < dataSources.getAllBusinessPartner.length; customerIdx++) {
					var customerObj = dataSources.getAllBusinessPartner[customerIdx];
					if (vendorObj.fuel_vendor_id === customerObj._sid) {
						vendorObj.fuel_vendor_name = customerObj.name;
					}
				}
			}
		}*/

		if(dataSources.getAllVendorsWithoutLimit){
			for (var vendorIdx = 0; vendorIdx < dataSources.getVendor.length; vendorIdx++) {
				var vendorObj = dataSources.getVendor[vendorIdx];
				for (var customerIdx = 0; customerIdx < dataSources.getAllVendorsWithoutLimit.length; customerIdx++) {
					var customerObj = dataSources.getAllVendorsWithoutLimit[customerIdx];
					if (vendorObj.fuel_vendor_id === customerObj._sid) {
						vendorObj.fuel_vendor_name = customerObj.business_partner_short_name;
					}
				}
			}
		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onAfterLoad)
			return TenantPurchaseInterface.onAfterLoad(dataSources);

		return dataSources;
	},

	onBeforeData: function(params, dataSources) {

		var allOkFlg = true;
		//var dates = getDates();
		var dates = getCustomFilterDates();

		dataSources.startDate = dates.startDate;
		dataSources.endDate = dates.endDate;

		if(params && params.length >= 3) {
			params[0] = dates.startDate;
			params[1] = dates.endDate;
		}

		if (dates == null) {
			if (!errFlg) {
				s_error(Strings.DATE_ERROR_TITLE, Strings.VALID_DATE_ERROR, dlgOptions);
				errFlg = true;
			}
			return false;
		}
		if (dates.startDate > dates.endDate) {
			if (!errFlg) {
				s_error(Strings.DATE_ERROR_TITLE, Strings.START_DATE_GREATER_THAN_END_DATE_ERROR, dlgOptions);
				errFlg = true;
			}

			return false;
		}

		//Custom code goes here



		if (TenantPurchaseInterface && TenantPurchaseInterface.onBeforeData)
			return TenantPurchaseInterface.onBeforeData(params, dataSources);

		return true;
	},

	onAfterData: function(isSuccessful, dataArr, dataSources) {
		//custom code goes here

		if (TenantPurchaseInterface && TenantPurchaseInterface.onAfterData)
			return TenantPurchaseInterface.onAfterData(isSuccessful, dataArr, dataSources);

		return dataArr;
	},

	renderData: function(value, type, dtObj, meta) {
		//custom code goes here
		var rVal;
		switch(meta.col){
			case 0 :
				if(value){
					rVal = this._getFormattedDate(value);
				}else{
					rVal = Strings.NA_STRING;
				}
				break;

			case 1 :
				rVal = this._getCodeName(value);
				break;

			case 2 :
				rVal = this._getVendorName(value);
				break;


			case 3:
				var decimalDigits = 3;
				var numberFormatForAmount = decimalDigits !== null ? new Intl.NumberFormat(localeCode, {
					style: "decimal",
					minimumFractionDigits: decimalDigits,
					maximumFractionDigits: decimalDigits
				}) : numberFormat;

				rVal = `<span style="display:inline-block; text-align:right; width:100%;">${numberFormatForAmount.format(value)}</span>`;
				break;

			case 4 :

				rVal = this._getUnitName(value);
				break;

			case 5:
				rVal = `<span style="display:inline-block; text-align:right; width:100%;">${currencyFormat.format(value)}</span>`;
				break;


		}


		if (TenantPurchaseInterface && TenantPurchaseInterface.renderData)
			return TenantPurchaseInterface.renderData(value, type, dtObj, meta);

		return rVal;
	},

	onBeforeCreate: function(dataObj, dataSources) {
		//custom code here

		if(mSelect && ySelect) {
			var year = parseInt(ySelect.value, 10);
			var month = parseInt(mSelect.value, 10);

			dataObj.purchase_date = Date.UTC(year, month, 1);
		}///

		if (dataObj && dataObj.remarks) {
			var value = dataObj.remarks;

			if (value.length > 100) {
				s_info(Strings.ERROR, Strings.INVALID_REMARKS_LENGTH, dlgOptions);
				return false;
			}

			var alphaNumericRegex = /^[a-zA-Z0-9\s]+$/;
			if (!alphaNumericRegex.test(value)) {
				s_info(Strings.ERROR, Strings.DESCRIPTION_ALPHANUMERIC_ERROR, dlgOptions);
				return false;
			}
		}

		if (dataObj && dataObj.fuel_vendor_id) {
			for(var idx = 0; idx < dataSources.getVendor.length; idx++){
				if(dataObj.fuel_vendor_id == dataSources.getVendor[idx].id && /-\s*inactive$/i.test(dataSources.getVendor[idx].fuel_vendor_name)){
					s_info(Strings.ERROR, Strings.INACTIVE_VENDOR, dlgOptions);
					return false;
				}
			}
		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onBeforeCreate)
			return TenantPurchaseInterface.onBeforeCreate(dataObj, dataSources);

		return dataObj;
	},

	onAfterCreate: function(isSuccessful, dataObj, dataSources) {
		//Custom code here
		if(dataObj.err_code && dataObj.err_code === 409){
			clCommon.hideLoader("createProgress");
			clCommon.enable(createPurchaseBtn);
			s_info(Strings.PURCHASE_ERROR_TITLE, Strings.DUPLICATE_PURCHASE_ON_SAMEMONTH, dlgOptions);
			return false;
		}


		if (TenantPurchaseInterface && TenantPurchaseInterface.onAfterCreate)
			return TenantPurchaseInterface.onAfterCreate(isSuccessful, dataObj, dataSources);

		return dataObj;
	},

	onBeforeUpdate: function(dataObj, dataSources) {
		//custom code here

		if(mSelect && ySelect) {
			var year = parseInt(ySelect.value, 10);
			var month = parseInt(mSelect.value, 10);

			dataObj.purchase_date = Date.UTC(year, month, 1);
		}

		if (dataObj && dataObj.remarks) {
			var value = dataObj.remarks;

			if (value.length > 100) {
				s_info(Strings.ERROR, Strings.INVALID_REMARKS_LENGTH, dlgOptions);
				return false;
			}

			var alphaNumericRegex = /^[a-zA-Z0-9\s]+$/;
			if (!alphaNumericRegex.test(value)) {
				s_info(Strings.ERROR, Strings.DESCRIPTION_ALPHANUMERIC_ERROR, dlgOptions);
				return false;
			}
		}

		if (dataObj && dataObj.fuel_vendor_id) {
			for(var idx = 0; idx < dataSources.getVendor.length; idx++){
				if(dataObj.fuel_vendor_id == dataSources.getVendor[idx].id && /-\s*inactive$/i.test(dataSources.getVendor[idx].fuel_vendor_name)){
					s_info(Strings.ERROR, Strings.INACTIVE_VENDOR, dlgOptions);
					return false;
				}
			}
		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onBeforeUpdate)
			return TenantPurchaseInterface.onBeforeUpdate(dataObj, dataSources);

		return dataObj;
	},

	onAfterUpdate: function(isSuccessful, dataObj, dataSources) {
		//Custom code here
		if(dataObj.err_code && dataObj.err_code === 409){
			clCommon.hideLoader("updateProgress");
			clCommon.enable(editPurchaseBtn);
			s_info(Strings.PURCHASE_ERROR_TITLE, Strings.DUPLICATE_PURCHASE_ON_SAMEMONTH, dlgOptions);
			return false;
		}


		if (TenantPurchaseInterface && TenantPurchaseInterface.onAfterUpdate)
			return TenantPurchaseInterface.onAfterUpdate(isSuccessful, dataObj, dataSources);

		return dataObj;
	},

	onBeforeDelete: function(dataObj, dataSources) {
		//custom code here


		if (TenantPurchaseInterface && TenantPurchaseInterface.onBeforeDelete)
			return TenantPurchaseInterface.onBeforeDelete(dataObj, dataSources);

		return dataObj;
	},

	onAfterDelete: function(isSuccessful, resultObj, dataSources) {
		//Custom code here


		if (TenantPurchaseInterface && TenantPurchaseInterface.onAfterDelete)
			return TenantPurchaseInterface.onAfterDelete(isSuccessful, resultObj, dataSources);

		return resultObj;
	},

	onChangeFilter: function(changedFilter) {
		//Custom code here

		var el = changedFilter.target ? changedFilter.target : changedFilter;
		if (el.id === 'filter_monthSelect' || el.id === 'filter_yearSelect') {
			if (el.options && el.options[el.selectedIndex]) {
				el.setAttribute("title", el.options[el.selectedIndex].text);
			}

			if (filterMSelect && filterYSelect) {
				var saveObj = {
					month: filterMSelect.value,
					year: filterYSelect.value
				};
				clCommon.setCookie("purchase_date", JSON.stringify(saveObj), 10);
			}
		}

		if(el.id === 'fuelCodeFilter'){
			if(fuelCodeFilter){
				var saveObj = {
					fuelCode : fuelCodeFilter.value
				};
				clCommon.setCookie("fuelCode", JSON.stringify(saveObj), 10);
			}
		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onChangeFilter)
			return TenantPurchaseInterface.onChangeFilter(changedFilter);

		return true;
	},

	onSearchChangeFilter: function(searchedFilter) {

		if (TenantPurchaseInterface && TenantPurchaseInterface.onSearchChangeFilter)
			return TenantPurchaseInterface.onSearchChangeFilter(searchedFilter);

		return true;
	},

	onRowItemClick: function(rowData) {
		//Custom code here

		if(dataSources.getCode){
			for (var codeIdx = 0; codeIdx < dataSources.getCode.length; codeIdx++) {
				if (rowData.fuel_code_id === dataSources.getCode[codeIdx].id) {
					rowData.fuel_code_name = dataSources.getCode[codeIdx].code;
				}
			}
		}


		if (TenantPurchaseInterface && TenantPurchaseInterface.onRowItemClick)
			return TenantPurchaseInterface.onRowItemClick(rowData);

		return rowData;
	},

	onDisplayForm: function(rowData) {
		//Custom code here
		if(rowData.fuel_code_id){
			previousCodeId = rowData.fuel_code_id;
		} else {
			previousCodeId = "";
		}


		if(rowData.purchase_date){
			var purchaseDate = new Date(rowData.purchase_date);
			var purchaseMonthIndex = purchaseDate.getMonth();
			var purchaseYear = purchaseDate.getFullYear();

			ySelect.value = purchaseYear;
			mSelect.value = purchaseMonthIndex;
		}

		//set title on form 
		if(rowData.purchase_date) {
			var dt = new Date(rowData.purchase_date);

			if(mSelect && ySelect) {
				mSelect.value = dt.getUTCMonth();
				ySelect.value = dt.getUTCFullYear();

				var selectedMonthOption = mSelect.options[mSelect.selectedIndex];
				var monthText = selectedMonthOption ? selectedMonthOption.text : "";

				var selectedYearOption = ySelect.options[ySelect.selectedIndex];
				var yearText = selectedYearOption ? selectedYearOption.text : "";

				mSelect.setAttribute("title", monthText);
				ySelect.setAttribute("title", yearText);
			}
		}



		if (TenantPurchaseInterface && TenantPurchaseInterface.onDisplayForm)
			return TenantPurchaseInterface.onDisplayForm(rowData);

		return rowData;
	},

	onClearForm: function(defaultObj, dataSources) {
		//Custom code here
		var currentDate = new Date();
		var currentMonthIndex = currentDate.getMonth();
		var currentYear = currentDate.getFullYear();

		ySelect.value = currentYear;
		mSelect.value = currentMonthIndex;

		previousCodeId = "";

		if (TenantPurchaseInterface && TenantPurchaseInterface.onClearForm)
			return TenantPurchaseInterface.onClearForm(defaultObj, dataSources);

		return defaultObj;
	},

	onFieldFocus: function(focusedField, dataSources) {

		if (TenantPurchaseInterface && TenantPurchaseInterface.onFieldFocus)
			return TenantPurchaseInterface.onFieldFocus(focusedField, dataSources);

	},


	onFieldChange: function(changedField, dataSources) {

		if (changedField.id === "purchaseFuel_code_id") {
			var selectedCodeId = purchaseFuel_code_id.getAttribute("Fuel_code_id");

			if(previousCodeId && previousCodeId !== selectedCodeId){
				purchaseFuel_vendor_id.value = "";
				purchaseFuel_vendor_id.setAttribute("Fuel_vendor_id", "");
			}

			previousCodeId = selectedCodeId;


			// Set Unit
			if (selectedCodeId && dataSources.getCode) {
				var codeObj = dataSources.getCode.find(c => c.id === selectedCodeId);
				if (codeObj && codeObj.unit) {
					var unitObj = dataSources.getUnit.find(u => u.id === codeObj.unit);
					if (unitObj) {
						purchaseFuel_unit_id.value = unitObj.unit;
						purchaseFuel_unit_id.setAttribute("Fuel_unit_id", unitObj.id);
					}
				}
			}
		}

		//calculate gst
		if (changedField.id === "purchaseFuel_value" || changedField.id === "purchaseFuel_code_id") {
			var selectedCodeId = purchaseFuel_code_id.getAttribute("Fuel_code_id");
			var fuelRate = Number(purchaseFuel_value.getAttribute("val")) || 0;

			if(!selectedCodeId){
				purchaseFuel_gst_value.setAttribute("val", 0);
				purchaseFuel_gst_value.value = currencyFormat.format(0);
			}


			if (selectedCodeId && dataSources.getCode) {
				var codeObj = dataSources.getCode.find(c => c.id === selectedCodeId);
				var gstRate = Number(codeObj.gst_rate);

				if(gstRate){
					var totalGst = (fuelRate * gstRate) / 100;
					purchaseFuel_gst_value.setAttribute("val", totalGst);
					purchaseFuel_gst_value.value = currencyFormat.format(totalGst);
				}else{
					purchaseFuel_gst_value.setAttribute("val", 0);
					purchaseFuel_gst_value.value = currencyFormat.format(0);
				}
			}
		}

		//calculate value and gst
		if (changedField.id === "purchaseFuel_value" || changedField.id === "purchaseFuel_gst_value" || changedField.id === "purchaseFuel_code_id") {
			var fuel = Number(purchaseFuel_value.getAttribute("val")) || 0;
			var gst  = Number(purchaseFuel_gst_value.getAttribute("val")) || 0;

			var tempVal = fuel + gst;

			purchaseTotal_fuel_value.setAttribute("val", tempVal);
			purchaseTotal_fuel_value.value = currencyFormat.format(tempVal);
		}

		//calculate total vale / qty

		if (changedField.id === "purchaseFuel_qty" || changedField.id === "purchaseFuel_value" || changedField.id === "purchaseFuel_gst_value" || changedField.id === "purchaseFuel_code_id") {
			var total = Number(purchaseTotal_fuel_value.getAttribute("val")) || 0;
			var qty   = Number(purchaseFuel_qty.getAttribute("val")) || 0;

			if(total !== 0 && qty !== 0 ){
				var unitPrice = total / qty;
				purchaseUnit_price.setAttribute("val", unitPrice);
				purchaseUnit_price.value = currencyFormat.format(unitPrice);
			}else if((qty === 0) || (total === 0 && qty !== 0)){
				purchaseUnit_price.setAttribute("val", 0);
				purchaseUnit_price.value = currencyFormat.format(0);
			}else{
				purchaseUnit_price.setAttribute("val", qty);
				purchaseUnit_price.value = currencyFormat.format(qty);
			}

		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onFieldChange)
			return TenantPurchaseInterface.onFieldChange(changedField, dataSources);

	},

	onToolBarBtnClick: function(changedField, dataSources) {
		if(changedField.id == "purchaseFuel_unit_idZoom"){
			return false;
		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onToolBarBtnClick)
			return TenantPurchaseInterface.onToolBarBtnClick(changedField, dataSources);

	},

	onLookupAddBtnClick: function(attribute, changedField, dataSources) {

		if (TenantPurchaseInterface && TenantPurchaseInterface.onLookupAddBtnClick)
			return TenantPurchaseInterface.onLookupAddBtnClick(attribute, changedField, dataSources);

	},

	onLookUpData: function(attribute, dataSources) {

		switch (attribute) {

			case "fuel_vendor_id":
				var vendorArr = [];
				var vendor_idFlg = false;
				var pushState = (typeof e !== 'undefined' && e !== false);

				// Get the currently selected Fuel Code ID
				var selectedCodeId = purchaseFuel_code_id.getAttribute("Fuel_code_id");

				var objective = {
					"id": purchaseFuel_vendor_id.getAttribute("Fuel_vendor_id")
				};

				var vendors = dataSources.getVendor;

				for (var venIdx = 0; venIdx < vendors.length; venIdx++) {
					var vendor = vendors[venIdx];

					if (selectedCodeId && vendor.fuel_code_id !== selectedCodeId) {
						continue;
					}

					if (vendor.fuel_vendor_id) {
						var checked = "";
						if (objective.id && objective.id == vendor.id) {
							checked = "checked";
							vendor_idFlg = true;
						} else if (rowData && rowData.fuel_vendor_id == vendor.id && !vendor_idFlg) {
							checked = "checked";
						}

						vendorArr.push({
							"fuel_vendor_idName": '<label for="' + vendor.id + '">' + vendor.fuel_vendor_name  + '</label>',
							"radio": '<input type="radio" name="fuel_vendor_idName" fuel_vendor_idId="' + vendor.id + '" fuel_vendor_idName="' + JSON.stringify(vendor).replaceAll('"', '$' + 'DQUOTE' + '$') + '" ' + checked + '>'
						});
					}
				}

				fuel_vendor_idTable.clear().draw();
				fuel_vendor_idTable.rows.add(vendorArr).draw();

				if (clCommon.isMobile() && pushState) {
					window.history.pushState('fuel_vendor_idForm', null, '#fuel_vendor_idsForm');
					clCommon.hide(contentView);
				}

				return false;
		}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onLookUpData)
			return TenantPurchaseInterface.onLookUpData(attribute, dataSources);

		return true;
	},

	onChangeOfActionSelect: function(changedAction, dataSources) {

		switch (changedAction.value) {}

		if (TenantPurchaseInterface && TenantPurchaseInterface.onChangeOfActionSelect)
			return TenantPurchaseInterface.onChangeOfActionSelect(changedAction, dataSources);

		return true;
	},

	_getFormattedDate: function (value) {
		if (!value) return '';
		const date = new Date(value);
		const localeStr = (userObj && userObj.realm_locale && userObj.realm_locale.code)? userObj.realm_locale.code: 'en-US';
		const month = date.toLocaleString(localeStr, { month: 'short' });
		const year = date.getUTCFullYear(); 
		return month + ' / ' + year;
	},

	_getCodeName: function(value){
		for(var codeIdx = 0; codeIdx < dataSources.getCode.length; codeIdx++){
			var codeObj = dataSources.getCode[codeIdx];
			if(value == codeObj.id){
				rVal = codeObj.code;
				break;
			}else{
				rVal = Strings.NA_STRING;

			}
		}
		return rVal;
	},

	_getVendorName: function (value) {
		var rVal = Strings.NA_STRING;

		for (var vendorIdx = 0; vendorIdx < dataSources.getVendor.length; vendorIdx++) {
			var vendorObj = dataSources.getVendor[vendorIdx];

			if (value === vendorObj.id) {
				for (var customerIdx = 0; customerIdx < dataSources.getAllVendorsWithoutLimit.length; customerIdx++) {
					var customerObj = dataSources.getAllVendorsWithoutLimit[customerIdx];

					if (vendorObj.fuel_vendor_id === customerObj._sid) {
						rVal = customerObj.business_partner_short_name;
						return rVal;
					}
				}
			}
		}

		return rVal;
	},


	_getUnitName: function(value){
		for(var unitIdx = 0; unitIdx < dataSources.getUnit.length; unitIdx++){
			var unitObj = dataSources.getUnit[unitIdx];
			if(value == unitObj.id){
				rVal = unitObj.unit;
				break;
			}else{
				rVal = Strings.NA_STRING;

			}
		}
		return rVal;
	},

};



function getCustomFilterDates() {
	var now = new Date();
	var month = now.getMonth();
	var year = now.getFullYear();

	// Check elements
	if(filterMSelect && filterYSelect) {
		month = parseInt(filterMSelect.value);
		year = parseInt(filterYSelect.value);
	} else {
		// Elements not ready, check Cookie
		var cookieVal = clCommon.getCookie("purchase_date");
		if(cookieVal) {
			try {
				var cObj = JSON.parse(cookieVal);
				month = parseInt(cObj.month);
				year = parseInt(cObj.year);
			} catch(e) { console.log(e); }
		}
	}


	var startDate = Date.UTC(year, month, 1, 0, 0, 0, 0);

	var endDate = Date.UTC(year, month + 1, 0, 23, 59, 59, 999);

	return {
		startDate: startDate,
		endDate: endDate
	};
}

function getAllVendorsPromise() {
	return Service.getAllVendorsWithoutLimit(function (respObj) {
		if (respObj && respObj.code === 200) {
			var vendorsArr = respObj.data || [];
			dataSources = dataSources || {};

			// Store raw data
			dataSources.getAllVendorsWithoutLimit = vendorsArr;

			if (dataSources.getAllVendorsWithoutLimit.length > 1) {
				dataSources.getAllVendorsWithoutLimit = clCommon.sort(dataSources.getAllVendorsWithoutLimit, "business_partner_short_name");
			}

			for (var t = 0; t < dataSources.getAllVendorsWithoutLimit.length; t++) {

				if(dataSources.getAllVendorsWithoutLimit[t].isactive == false){
					dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name += " - Inactive"
				}

				try {
					dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name = scrypto.decrypt(dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name);
				} catch (e) {
					dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name = dataSources.getAllVendorsWithoutLimit[t].business_partner_short_name;
				}

			}

		}
	});
}


function getAllBusinessPartnerPromise() {
	return Service.getAllBusinessPartner(function (respObj) {
		if (respObj && respObj.code === 200) {
			var businessPartnerArr = respObj.data || [];
			dataSources = dataSources || {};

			// Store raw data
			dataSources.getAllBusinessPartner = businessPartnerArr;

			if (dataSources.getAllBusinessPartner.length > 1) {
				dataSources.getAllBusinessPartner = clCommon.sort(dataSources.getAllBusinessPartner, "name");
			}

			for (var t = 0; t < dataSources.getAllBusinessPartner.length; t++) {
				try {
					dataSources.getAllBusinessPartner[t].name = scrypto.decrypt(dataSources.getAllBusinessPartner[t].name);
				} catch (e) {
					dataSources.getAllBusinessPartner[t].name = dataSources.getAllBusinessPartner[t].name;
				}

			}
		} 
	});

}


function convertDateToMonthYearPicker() {

	if (document.getElementById('purchase_date_monthSelect')) {
		return;
	}
	var fuelUnitContainer = document.querySelector('div[field="fuel_unit_id"]');
	var formGroupContainer; 

	if (fuelUnitContainer) {
		var newCol = document.createElement('div');
		newCol.className = 'col-sm-12';
		newCol.setAttribute('field', 'purchase_date');
		newCol.setAttribute('data-expand-class', 'col-lg-3 col-md-4');
		newCol.setAttribute('data-normal-class', 'col-sm-12');

		// Create the Form Group
		formGroupContainer = document.createElement('div');
		formGroupContainer.id = 'purchasePurchase_dateForTour';
		formGroupContainer.className = 'form-group mb-3';

		// Create Label
		var label = document.createElement('label');
		label.className = 'form-label';
		label.setAttribute('data-string-key', 'LABEL_PURCHASE_DATE');
		label.innerHTML = Strings.DATELABEL + '<sup>*</sup>';

		// Append Label to Group
		formGroupContainer.appendChild(label);

		// Append Group to Column
		newCol.appendChild(formGroupContainer);
		fuelUnitContainer.parentNode.insertBefore(newCol, fuelUnitContainer.nextSibling);
	}

	var wrapper = document.createElement('div');
	wrapper.className = 'd-flex'; 

	// Create Month Select
	var monthSelect = document.createElement('select');
	monthSelect.id = 'purchase_date_monthSelect';
	monthSelect.className = 'form-select';
	monthSelect.style.marginRight = '10px';

	var months = [
		"Jan", "Feb", "Mar", "Apr", "May", "Jun", 
		"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
	];

	var currentDate = new Date();
	var currentMonthIndex = currentDate.getMonth();
	var currentYear = currentDate.getFullYear();

	months.forEach(function(month, index) {
		var option = document.createElement('option');
		option.value = index; 
		option.innerText = month;
		if (index === currentMonthIndex) {
			//option.selected = true;
		}
		monthSelect.appendChild(option);
	});

	// Create Year Select
	var yearSelect = document.createElement('select');
	yearSelect.id = 'purchase_date_yearSelect';
	yearSelect.className = 'form-select';

	// Populate Year Options (Current -10 to +10)
	var startYear = currentYear - 10;
	var endYear = currentYear + 10;

	for (var i = startYear; i <= endYear; i++) {
		var option = document.createElement('option');
		option.value = i;
		option.innerText = i;
		if (i === currentYear) {
			//option.selected = true;
		}
		yearSelect.appendChild(option);
	}

	wrapper.appendChild(monthSelect);
	wrapper.appendChild(yearSelect);

	formGroupContainer.appendChild(wrapper);

	monthSelect.addEventListener('change', onFieldChange);
	monthSelect.addEventListener('focus', onFieldFocus);
	monthSelect.addEventListener('blur', onFieldChange);

	yearSelect.addEventListener('change', onFieldChange);
	yearSelect.addEventListener('focus', onFieldFocus);
	yearSelect.addEventListener('blur', onFieldChange);
}

function createFilterMonthYearPicker() {

	if (document.getElementById('custom_filter_wrapper')) return;


	var container = document.getElementById('dateFilterContainer');

	if (!container) {
		var fuelCodeFilter = document.getElementById('fuelCodeFilter');

		if(fuelCodeFilter) {
			var fuelCodeContainer = fuelCodeFilter.closest('.form-group') || fuelCodeFilter.parentNode;

			// Create a new container for the Date Picker
			container = document.createElement('div');
			container.id = 'dateFilterContainer';
			container.className = 'form-group mb-3'; 

			// Insert BEFORE the Fuel code Container 
			if(fuelCodeContainer && fuelCodeContainer.parentNode) {
				fuelCodeContainer.parentNode.insertBefore(container, fuelCodeContainer);
			}
		} 
		else {
			// Fallback: Append to the main filter row if Fuel Code filter is missing
			var filterRow = document.getElementById('selectFilters');
			if(filterRow) {
				container = document.createElement('div');
				container.id = 'dateFilterContainer';
				container.className = 'form-group mb-3';
				filterRow.insertBefore(container, filterRow.firstChild);
			} else {
				return;
			}
		}
	}

	// Create Wrapper for Dropdowns
	var wrapper = document.createElement('div');
	wrapper.id = 'custom_filter_wrapper';
	wrapper.className = 'd-flex';

	// Create Month Select
	filterMSelect = document.createElement('select');
	filterMSelect.id = 'filter_monthSelect';
	filterMSelect.className = 'form-select';
	filterMSelect.style.marginRight = '10px';

	var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
	var now = new Date();

	// Check Cookie
	var cookieVal = clCommon.getCookie("purchase_date");
	var storedMonth = now.getMonth();
	var storedYear = now.getFullYear();

	if(cookieVal) {
		try {
			var cObj = JSON.parse(cookieVal);
			storedMonth = parseInt(cObj.month);
			storedYear = parseInt(cObj.year);
		} catch(e) { console.error(e); }
	}

	// Populate Month
	months.forEach(function(m, i) {
		var opt = document.createElement('option');
		opt.value = i;
		opt.text = m;
		if(i === storedMonth) opt.selected = true;
		filterMSelect.appendChild(opt);
	});

	//Create Year Select
	filterYSelect = document.createElement('select');
	filterYSelect.id = 'filter_yearSelect';
	filterYSelect.className = 'form-select';

	// Populate Year
	for(var i = now.getFullYear() - 10; i <= now.getFullYear() + 10; i++) {
		var opt = document.createElement('option');
		opt.value = i;
		opt.text = i;
		if(i === storedYear) opt.selected = true;
		filterYSelect.appendChild(opt);
	}

	// Initial Title Setup
	if(filterMSelect.options[filterMSelect.selectedIndex]) 
		filterMSelect.setAttribute("title", filterMSelect.options[filterMSelect.selectedIndex].text);
	if(filterYSelect.options[filterYSelect.selectedIndex]) 
		filterYSelect.setAttribute("title", filterYSelect.options[filterYSelect.selectedIndex].text);


	filterMSelect.addEventListener('change', onChangeOfFilter);
	filterYSelect.addEventListener('change', onChangeOfFilter);


	// Append to DOM
	wrapper.appendChild(filterMSelect);
	wrapper.appendChild(filterYSelect);
	container.appendChild(wrapper);
}



