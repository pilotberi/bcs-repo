/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Wed Jan 14 2026 15:56:29 GMT+0530 (India Standard Time)
	Description : Interface Logic for BCSSteam List Details.
	WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS.
	Custom code can be writter here.
	Use customDtOpns object to maniuplate data table.
*/

var mSelect,ySelect;
var filterMSelect, filterYSelect;
var sfmLdCount = 0;

if (typeof TenantUtilityInterface === 'undefined')
	TenantUtilityInterface = {};

var UtilityInterface = {
	onLoad: function() {
		//Custom code goes here
		document.querySelector("title").innerHTML = "BCS Steam";
		document.querySelector("span").innerHTML = "BCS Steam";

		clCommon.hide(document.getElementById("nav-action-tab"));
		document.querySelector("#sfmCodeFilter option[value='all']").innerHTML = "All Sfm Code";

		convertDateToMonthYearPicker();
		mSelect = document.getElementById('utilityRecord_monthSelect');
		ySelect = document.getElementById('utilityRecord_yearSelect');

		createFilterMonthYearPicker();


		if (TenantUtilityInterface && TenantUtilityInterface.onLoad)
			return TenantUtilityInterface.onLoad();

		return true;
	},

	onBeforeLoad: function(dataSources) {

		common_util.setSfmCodeCookie();

		var dates = getCustomFilterDates();
		dataSources.startDate = dates.startDate;
		dataSources.endDate = dates.endDate;



		if (TenantUtilityInterface && TenantUtilityInterface.onBeforeLoad)
			return TenantUtilityInterface.onBeforeLoad();

		return dataSources;
	},

	onAfterLoad: function(dataSources) {

		clCommon.hide(sfm_code_idAddBtn);
		clCommon.hide(reasonAddBtn);	

		if (clCommon.isMobile()) {
			clCommon.hide(filterActionsUtilityBtn);
		}

		if(dataSources.getAllSfmWithoutLimit && sfmLdCount == 0){
			sfmLdCount++;
			for(var sfmIdx = 0; sfmIdx < dataSources.getAllSfmWithoutLimit.length; sfmIdx++){
				var sfmObj = dataSources.getAllSfmWithoutLimit[sfmIdx];
				if (sfmObj.isactive === false || sfmObj.isactive == null) {
					dataSources.getAllSfmWithoutLimit[sfmIdx].sfm_code = dataSources.getAllSfmWithoutLimit[sfmIdx].sfm_code + ' - Inactive';
				}
			}
		}

		if (TenantUtilityInterface && TenantUtilityInterface.onAfterLoad)
			return TenantUtilityInterface.onAfterLoad(dataSources);

		return dataSources;
	},

	onBeforeData: function(params, dataSources) {

		var allOkFlg = true;
		//var dates = getDates();
		var dates = getCustomFilterDates();

		dataSources.startDate = dates.startDate;
		dataSources.endDate = dates.endDate;

		if(params && params.length >= 3) {
			params[1] = dates.startDate;
			params[2] = dates.endDate;
		}

		if (dates == null) {
			if (!errFlg) {
				s_error(Strings.DATE_ERROR_TITLE, Strings.VALID_DATE_ERROR, dlgOptions);
				errFlg = true;
			}
			return false;
		}
		if (dates.startDate > dates.endDate) {
			if (!errFlg) {
				s_error(Strings.DATE_ERROR_TITLE, Strings.START_DATE_GREATER_THAN_END_DATE_ERROR, dlgOptions);
				errFlg = true;
			}

			return false;
		}

		//Custom code goes here




		if (TenantUtilityInterface && TenantUtilityInterface.onBeforeData)
			return TenantUtilityInterface.onBeforeData(params, dataSources);

		return true;
	},

	onAfterData: function(isSuccessful, dataArr, dataSources) {
		//custom code goes here

		if (TenantUtilityInterface && TenantUtilityInterface.onAfterData)
			return TenantUtilityInterface.onAfterData(isSuccessful, dataArr, dataSources);

		return dataArr;
	},

	renderData: function(value, type, dtObj, meta) {
		//custom code goes here
		var rVal;
		switch(meta.col){
			case 0 :
				if(value){
					rVal = this._getFormattedDate(value);
				}else{
					rVal = Strings.NA_STRING;
				}
				break;

			case 1 :
				rVal = this._getSfmId(value);
				break;

			case 2:
				var decimalDigits = 3;
				var numberFormatForAmount = decimalDigits !== null ? new Intl.NumberFormat(localeCode, {
					style: "decimal",
					minimumFractionDigits: decimalDigits,
					maximumFractionDigits: decimalDigits
				}) : numberFormat;

				rVal = `<span style="display:inline-block; text-align:right; width:100%;">${numberFormatForAmount.format(value)}</span>`;
				break;

			case 3 :
				rVal = this._getReasonCode(value);
				break;


		}

		if (TenantUtilityInterface && TenantUtilityInterface.renderData)
			return TenantUtilityInterface.renderData(value, type, dtObj, meta);

		return rVal;
	},

	onBeforeCreate: function(dataObj, dataSources) {
		//custom code here

		//dataObj.record_date = utilityRecord_date.valueAsNumber;
		if (dataObj && dataObj.sfm_code_id) {
			for(var idx = 0; idx < dataSources.getAllSfmWithoutLimit.length; idx++){
				if(dataObj.sfm_code_id == dataSources.getAllSfmWithoutLimit[idx]._sid && (dataSources.getAllSfmWithoutLimit[idx].isactive == false || dataSources.getAllSfmWithoutLimit[idx].isactive == null)){
					s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.INACTIVE_SFM, dlgOptions);
					return false;
				}
			}
		}

		if(mSelect && ySelect) {
			var year = parseInt(ySelect.value, 10);
			var month = parseInt(mSelect.value, 10);

			dataObj.record_date = Date.UTC(year, month, 1);
		}///


		if (dataObj && dataObj.remarks) {
			var value = dataObj.remarks;

			if (value.length > 100) {
				s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.INVALID_REMARKS_LENGTH, dlgOptions);
				return false;
			}
		}


		if (TenantUtilityInterface && TenantUtilityInterface.onBeforeCreate)
			return TenantUtilityInterface.onBeforeCreate(dataObj, dataSources);

		return dataObj;
	},

	onAfterCreate: function(isSuccessful, dataObj, dataSources) {
		//Custom code here
		if(dataObj.err_code && dataObj.err_code === 409){
			clCommon.hideLoader("createProgress");
			clCommon.enable(createUtilityBtn);
			s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.DUPLICATE_UTILITY_ON_SAMEMONTH, dlgOptions);

			return false;
		}


		if (TenantUtilityInterface && TenantUtilityInterface.onAfterCreate)
			return TenantUtilityInterface.onAfterCreate(isSuccessful, dataObj, dataSources);

		return dataObj;
	},

	onBeforeUpdate: function(dataObj, dataSources) {
		//custom code here
		//dataObj.record_date = utilityRecord_date.valueAsNumber;
		if (dataObj && dataObj.sfm_code_id) {
			for(var idx = 0; idx < dataSources.getAllSfmWithoutLimit.length; idx++){
				if(dataObj.sfm_code_id == dataSources.getAllSfmWithoutLimit[idx]._sid && (dataSources.getAllSfmWithoutLimit[idx].isactive == false || dataSources.getAllSfmWithoutLimit[idx].isactive == null)){
					s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.INACTIVE_SFM, dlgOptions);
					return false;
				}
			}
		}


		if(mSelect && ySelect) {
			var year = parseInt(ySelect.value, 10);
			var month = parseInt(mSelect.value, 10);

			dataObj.record_date = Date.UTC(year, month, 1);
		}

		if (dataObj && dataObj.remarks) {
			var value = dataObj.remarks;

			if (value.length > 100) {
				s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.INVALID_REMARKS_LENGTH, dlgOptions);
				return false;
			}
		}


		if (TenantUtilityInterface && TenantUtilityInterface.onBeforeUpdate)
			return TenantUtilityInterface.onBeforeUpdate(dataObj, dataSources);

		return dataObj;
	},

	onAfterUpdate: function(isSuccessful, dataObj, dataSources) {
		//Custom code here
		if(dataObj.err_code && dataObj.err_code === 409){
			clCommon.hideLoader("updateProgress");
			clCommon.enable(editUtilityBtn);
			s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.DUPLICATE_UTILITY_ON_SAMEMONTH, dlgOptions);

			return false;
		}

		if (TenantUtilityInterface && TenantUtilityInterface.onAfterUpdate)
			return TenantUtilityInterface.onAfterUpdate(isSuccessful, dataObj, dataSources);

		return dataObj;
	},

	onBeforeDelete: function(dataObj, dataSources) {
		//custom code here


		if (TenantUtilityInterface && TenantUtilityInterface.onBeforeDelete)
			return TenantUtilityInterface.onBeforeDelete(dataObj, dataSources);

		return dataObj;
	},

	onAfterDelete: function(isSuccessful, resultObj, dataSources) {
		//Custom code here


		if (TenantUtilityInterface && TenantUtilityInterface.onAfterDelete)
			return TenantUtilityInterface.onAfterDelete(isSuccessful, resultObj, dataSources);

		return resultObj;
	},

	onChangeFilter: function(changedFilter) {
		//Custom code here

		var el = changedFilter.target ? changedFilter.target : changedFilter;
		if (el.id === 'filter_monthSelect' || el.id === 'filter_yearSelect') {
			if (el.options && el.options[el.selectedIndex]) {
				el.setAttribute("title", el.options[el.selectedIndex].text);
			}

			if (filterMSelect && filterYSelect) {
				var saveObj = {
					month: filterMSelect.value,
					year: filterYSelect.value
				};
				clCommon.setCookie("utility_filter_date", JSON.stringify(saveObj), 10);
			}
		}

		if(el.id === 'sfmCodeFilter'){
			if(sfmCodeFilter){
				var saveObj = {
					sfmCode : sfmCodeFilter.value
				};
				clCommon.setCookie("sfmCode", JSON.stringify(saveObj), 10);
			}
		}



		if (TenantUtilityInterface && TenantUtilityInterface.onChangeFilter)
			return TenantUtilityInterface.onChangeFilter(changedFilter);

		return true;
	},

	onSearchChangeFilter: function(searchedFilter) {

		if (TenantUtilityInterface && TenantUtilityInterface.onSearchChangeFilter)
			return TenantUtilityInterface.onSearchChangeFilter(searchedFilter);

		return true;
	},

	onRowItemClick: function(rowData) {
		//Custom code here
		if(rowData.sfm_code_id){
			for(var idx = 0; idx < dataSources.getAllSfmWithoutLimit.length; idx++){
				if(rowData.sfm_code_id == dataSources.getAllSfmWithoutLimit[idx]._sid){
					rowData.sfm_code_name = dataSources.getAllSfmWithoutLimit[idx].sfm_code;
				}
			}
		}

		if (TenantUtilityInterface && TenantUtilityInterface.onRowItemClick)
			return TenantUtilityInterface.onRowItemClick(rowData);

		return rowData;
	},

	onDisplayForm: function(rowData) {
		//Custom code here
		/*if(rowData.record_date){
			utilityRecord_date.valueAsNumber = rowData.record_date;
		}*/

		if(rowData.record_date) {
			var dt = new Date(rowData.record_date);

			if(mSelect && ySelect) {
				mSelect.value = dt.getUTCMonth();
				ySelect.value = dt.getUTCFullYear();

				var selectedMonthOption = mSelect.options[mSelect.selectedIndex];
				var monthText = selectedMonthOption ? selectedMonthOption.text : "";

				var selectedYearOption = ySelect.options[ySelect.selectedIndex];
				var yearText = selectedYearOption ? selectedYearOption.text : "";

				mSelect.setAttribute("title", monthText);
				ySelect.setAttribute("title", yearText);
			}
		}///



		if (TenantUtilityInterface && TenantUtilityInterface.onDisplayForm)
			return TenantUtilityInterface.onDisplayForm(rowData);

		return rowData;
	},

	onClearForm: function(defaultObj, dataSources) {
		//Custom code here

		// Set them to current Month and Year title
		if (mSelect && ySelect) {
			var now = new Date();
			mSelect.value = now.getMonth();   
			ySelect.value = now.getFullYear();

			if (mSelect.options[mSelect.selectedIndex]) {
				mSelect.setAttribute("title", mSelect.options[mSelect.selectedIndex].text);
			}

			if (ySelect.options[ySelect.selectedIndex]) {
				ySelect.setAttribute("title", ySelect.options[ySelect.selectedIndex].text);
			}
		}

		if (TenantUtilityInterface && TenantUtilityInterface.onClearForm)
			return TenantUtilityInterface.onClearForm(defaultObj, dataSources);

		return defaultObj;
	},

	onFieldFocus: function(focusedField, dataSources) {

		if (TenantUtilityInterface && TenantUtilityInterface.onFieldFocus)
			return TenantUtilityInterface.onFieldFocus(focusedField, dataSources);

	},


	onFieldChange: function(changedField, dataSources) {

		if (TenantUtilityInterface && TenantUtilityInterface.onFieldChange)
			return TenantUtilityInterface.onFieldChange(changedField, dataSources);

	},

	onToolBarBtnClick: function(changedField, dataSources) {

		if (TenantUtilityInterface && TenantUtilityInterface.onToolBarBtnClick)
			return TenantUtilityInterface.onToolBarBtnClick(changedField, dataSources);

	},

	onLookupAddBtnClick: function(attribute, changedField, dataSources) {

		if (TenantUtilityInterface && TenantUtilityInterface.onLookupAddBtnClick)
			return TenantUtilityInterface.onLookupAddBtnClick(attribute, changedField, dataSources);

	},

	onLookUpData: function(attribute, dataSources) {

		if (TenantUtilityInterface && TenantUtilityInterface.onLookUpData)
			return TenantUtilityInterface.onLookUpData(attribute, dataSources);

		return true;

	},

	onChangeOfActionSelect: function(changedAction, dataSources) {

		switch (changedAction.value) {}

		if (TenantUtilityInterface && TenantUtilityInterface.onChangeOfActionSelect)
			return TenantUtilityInterface.onChangeOfActionSelect(changedAction, dataSources);

		return true;
	},
	_getFormattedDate: function (value) {
		if (!value) return '';
		const date = new Date(value);
		const localeStr = (userObj && userObj.realm_locale && userObj.realm_locale.code)? userObj.realm_locale.code: 'en-US';
		const month = date.toLocaleString(localeStr, { month: 'short' });
		const year = date.getUTCFullYear(); 
		return month + ' / ' + year;
	},


	_getSfmId: function(value){
		for(var sfmIdx = 0; sfmIdx < dataSources.getAllSfmWithoutLimit.length; sfmIdx++){
			var sfmObj = dataSources.getAllSfmWithoutLimit[sfmIdx];
			if(value == sfmObj._sid){
				rVal = sfmObj.sfm_code;
				break;
			}else{
				rVal = Strings.NA_STRING;

			}
		}
		return rVal;
	},

	_getReasonCode: function(value){
		for(var codeIdx = 0; codeIdx < dataSources.getSfmReadingReasonCode.length; codeIdx++){
			var codeObj = dataSources.getSfmReadingReasonCode[codeIdx];
			if(value == codeObj.id){
				value = codeObj.reading_reason_code;
				rVal = value
				break;
			}else{
				rVal = Strings.NA_STRING;

			}
		}
		return rVal;
	}

};

function convertDateToMonthYearPicker() {

	if (document.getElementById('utilityRecord_monthSelect')) {
		return;
	}
	var sfmContainer = document.querySelector('div[field="sfm_code_id"]');
	var formGroupContainer; 

	if (sfmContainer) {
		var newCol = document.createElement('div');
		newCol.className = 'col-sm-12';
		newCol.setAttribute('field', 'record_date');
		newCol.setAttribute('data-expand-class', 'col-lg-3 col-md-4');
		newCol.setAttribute('data-normal-class', 'col-sm-12');

		// Create the Form Group
		formGroupContainer = document.createElement('div');
		formGroupContainer.id = 'utilityRecord_dateForTour';
		formGroupContainer.className = 'form-group mb-3';

		// Create Label
		var label = document.createElement('label');
		label.className = 'form-label';
		label.setAttribute('data-string-key', 'LABEL_RECORD_DATE');
		label.innerHTML = 'Month / Year<sup>*</sup>';

		// Append Label to Group
		formGroupContainer.appendChild(label);

		// Append Group to Column
		newCol.appendChild(formGroupContainer);
		sfmContainer.parentNode.insertBefore(newCol, sfmContainer.nextSibling);
	}

	var wrapper = document.createElement('div');
	wrapper.className = 'd-flex'; 

	// Create Month Select
	var monthSelect = document.createElement('select');
	monthSelect.id = 'utilityRecord_monthSelect';
	monthSelect.className = 'form-select';
	monthSelect.style.marginRight = '10px';

	var months = [
		"Jan", "Feb", "Mar", "Apr", "May", "Jun", 
		"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
	];

	var currentDate = new Date();
	var currentMonthIndex = currentDate.getMonth();
	var currentYear = currentDate.getFullYear();

	months.forEach(function(month, index) {
		var option = document.createElement('option');
		option.value = index; 
		option.innerText = month;
		if (index === currentMonthIndex) {
			option.selected = true;
		}
		monthSelect.appendChild(option);
	});

	// Create Year Select
	var yearSelect = document.createElement('select');
	yearSelect.id = 'utilityRecord_yearSelect';
	yearSelect.className = 'form-select';

	// Populate Year Options (Current -10 to +10)
	var startYear = currentYear - 10;
	var endYear = currentYear + 10;

	for (var i = startYear; i <= endYear; i++) {
		var option = document.createElement('option');
		option.value = i;
		option.innerText = i;
		if (i === currentYear) {
			option.selected = true;
		}
		yearSelect.appendChild(option);
	}

	wrapper.appendChild(monthSelect);
	wrapper.appendChild(yearSelect);

	formGroupContainer.appendChild(wrapper);
}

function getCustomFilterDates() {
	var now = new Date();
	var month = now.getMonth();
	var year = now.getFullYear();

	// Check elements
	if(filterMSelect && filterYSelect) {
		month = parseInt(filterMSelect.value);
		year = parseInt(filterYSelect.value);
	} else {
		// Elements not ready, check Cookie
		var cookieVal = clCommon.getCookie("utility_filter_date");
		if(cookieVal) {
			try {
				var cObj = JSON.parse(cookieVal);
				month = parseInt(cObj.month);
				year = parseInt(cObj.year);
			} catch(e) { console.log(e); }
		}
	}


	var startDate = Date.UTC(year, month, 1, 0, 0, 0, 0);

	var endDate = Date.UTC(year, month + 1, 0, 23, 59, 59, 999);

	return {
		startDate: startDate,
		endDate: endDate
	};
}

function createFilterMonthYearPicker() {

	if (document.getElementById('custom_filter_wrapper')) return;


	var container = document.getElementById('dateFilterContainer');

	if (!container) {
		var sfmFilter = document.getElementById('sfmCodeFilter');

		if(sfmFilter) {
			var sfmContainer = sfmFilter.closest('.form-group') || sfmFilter.parentNode;

			// Create a new container for the Date Picker
			container = document.createElement('div');
			container.id = 'dateFilterContainer';
			container.className = 'form-group mb-3'; 

			// Insert BEFORE the SFM Container 
			if(sfmContainer && sfmContainer.parentNode) {
				sfmContainer.parentNode.insertBefore(container, sfmContainer);
			}
		} 
		else {
			// Fallback: Append to the main filter row if SFM filter is missing
			var filterRow = document.getElementById('selectFilters');
			if(filterRow) {
				container = document.createElement('div');
				container.id = 'dateFilterContainer';
				container.className = 'form-group mb-3';
				filterRow.insertBefore(container, filterRow.firstChild);
			} else {
				return;
			}
		}
	}

	// Create Wrapper for Dropdowns
	var wrapper = document.createElement('div');
	wrapper.id = 'custom_filter_wrapper';
	wrapper.className = 'd-flex';

	// Create Month Select
	filterMSelect = document.createElement('select');
	filterMSelect.id = 'filter_monthSelect';
	filterMSelect.className = 'form-select';
	filterMSelect.style.marginRight = '10px';

	var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
	var now = new Date();

	// Check Cookie
	var cookieVal = clCommon.getCookie("utility_filter_date");
	var storedMonth = now.getMonth();
	var storedYear = now.getFullYear();

	if(cookieVal) {
		try {
			var cObj = JSON.parse(cookieVal);
			storedMonth = parseInt(cObj.month);
			storedYear = parseInt(cObj.year);
		} catch(e) { console.error(e); }
	}

	// Populate Month
	months.forEach(function(m, i) {
		var opt = document.createElement('option');
		opt.value = i;
		opt.text = m;
		if(i === storedMonth) opt.selected = true;
		filterMSelect.appendChild(opt);
	});

	//Create Year Select
	filterYSelect = document.createElement('select');
	filterYSelect.id = 'filter_yearSelect';
	filterYSelect.className = 'form-select';

	// Populate Year
	for(var i = now.getFullYear() - 10; i <= now.getFullYear() + 10; i++) {
		var opt = document.createElement('option');
		opt.value = i;
		opt.text = i;
		if(i === storedYear) opt.selected = true;
		filterYSelect.appendChild(opt);
	}

	// Initial Title Setup
	if(filterMSelect.options[filterMSelect.selectedIndex]) 
		filterMSelect.setAttribute("title", filterMSelect.options[filterMSelect.selectedIndex].text);
	if(filterYSelect.options[filterYSelect.selectedIndex]) 
		filterYSelect.setAttribute("title", filterYSelect.options[filterYSelect.selectedIndex].text);


	filterMSelect.addEventListener('change', onChangeOfFilter);
	filterYSelect.addEventListener('change', onChangeOfFilter);


	// Append to DOM
	wrapper.appendChild(filterMSelect);
	wrapper.appendChild(filterYSelect);
	container.appendChild(wrapper);
}