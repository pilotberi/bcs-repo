/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Mon Jan 05 2026 12:16:59 GMT+0530 (India Standard Time)
	Description : Get Service for workingprinciple
	WARNING : DO NOT MODIFY THIS FILE
*/

//External library
var dsclientUtil = require('dsclient');
var uuid = require('uuid');

//Getting user attributes 
var user = auth.getUser();


//Internal library
var Strings = require("../common/strings.js");
var appcommon = require("../common/common.js");
var getWorkingPrincipleInterface = require("getworkingprincipleinterface.js");

//Default Data
var DEFAULT_DATA = [];


function setDefaultMasterData(defaultArr) {
  var defaultObj = {
    "edited_by": user.username,
    "edited_on": new Date().getTime(),
    "master_data": [{
      "id": null,
      "name": ""
    }]

  };
  defaultObj = updateMasterData(defaultArr, defaultObj);


  //Success response object
  var respObj = {
    code: 200,
    msg: Strings.UPDATE_WORKINGPRINCIPLE_SUCCESS
  };

  var MASTER_TABLE = "bcssteam_workingPrinciple";

  var queryParams = {
    "cols": ["master_name", "master_data", "edited_by", "edited_on"],
    "filter": [{
      "col": "master_name",
      "op": "=",
      "val": MASTER_TABLE
    }]
  };

  if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.beforeExecute)
    queryParams = getWorkingPrincipleInterface.beforeExecute(queryParams, "query");

  var masterRespObj = dsclientUtil.execute(queryParams, "BCSSteam", "BCSSteam_combined_master", "query");
  if (masterRespObj) {
    var newData = defaultObj;
    var dataArr = newData.master_data;
    for (var d = 0; d < dataArr.length; d++) {
      var dataObj = dataArr[d];
      if (!dataObj.id)
        dataObj.id = uuid.get();

      dataArr[d] = dataObj;
    }


    var masterObj = (masterRespObj.data.length > 0) ? masterRespObj.data[0] : null; //There will always be only one entry in combined Master for a specific master table


    if (masterObj) { //master already has data, new data should be appended
      masterObj.master_data = JSON.stringify(dataArr);
      masterObj.edited_by = newData.edited_by;
      masterObj.edited_on = newData.edited_on;

      var masterDataStr = JSON.stringify(masterObj);

      if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.beforeExecute)
        masterDataStr = getWorkingPrincipleInterface.beforeExecute(masterDataStr, "update");

      //Sending request to ds client
      respObj = dsclientUtil.execute({
        data: masterDataStr
      }, "BCSSteam", "BCSSteam_combined_master", "update");

    } else { //master has no data, new data should be created
      masterObj = {
        "master_name": MASTER_TABLE,
        "master_data": JSON.stringify(dataArr),
        "edited_by": newData.edited_by,
        "edited_on": newData.edited_on
      };

      var masterDataStr = JSON.stringify(masterObj);

      if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.beforeExecute)
        masterDataStr = getWorkingPrincipleInterface.beforeExecute(masterDataStr, "insert");

      //Sending request to ds client
      respObj = dsclientUtil.execute({
        data: masterDataStr
      }, "BCSSteam", "BCSSteam_combined_master", "insert");
		
		if(!Array.isArray(respObj.data)){
			respObj.data = [respObj.data];
		}
    }

    switch (respObj.code) {
      case 200:
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onAfterData)
          respObj.data = getWorkingPrincipleInterface.onAfterData(respObj.data);
        respObj.msg = Strings.UPDATE_WORKINGPRINCIPLE_SUCCESS;
        break;
      case 400:
        respObj.msg = Strings.UPDATE_WORKINGPRINCIPLE_ERROR;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("Unable to create the 'workingPrinciple' - " + paramStr);
        break;
      case 403:
        respObj.msg = Strings.ACCESS_DENIED;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("User access denied when creating the 'workingPrinciple' - " + paramStr);
        break;
      case 500:
        respObj.msg = Strings.SERVER_ERROR;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("Unexpected server error when creating the 'workingPrinciple' - " + paramStr);
        break;
    }


  } else {
    respObj.code = 400;
    respObj.msg = Strings.UPDATE_APPLICATION_SOURCES_MASTER_ERROR;
    if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
      respObj = getWorkingPrincipleInterface.onError(respObj);
    console.error("Unable to update 'Application sources'- Master not found");
  }
  return respObj;
}


function updateMasterData(arr, obj) {
  // Iterate over the master_data array
  for (var i = 0; i < obj.master_data.length; i++) {
    // Check if there's a corresponding object in arr
    if (i < arr.length) {
      // Update each key-value pair from arr[i] into obj.master_data[i]
      for (var key in arr[i]) {
        if (arr[i].hasOwnProperty(key)) {
          obj.master_data[i][key] = arr[i][key]; // Assign key-value pair to obj.master_data
        }
      }
    }
  }
  return obj;
}


try {

  //Setting cache as null
  $g.response.headers["Cache-Control"] = "max-age=0";
  $g.response.headers["Cache-Control"] = "no-store";


  //Success response object
  var respObj = {
    code: 200,
    msg: Strings.READ_WORKINGPRINCIPLE_SUCCESS
  };


  //Checking whether the request is in query or body
  var params = appcommon.processParams($g.request);
  var paramStr = JSON.stringify(params);

  //check for Language setup 
  if (params && params.l) {
    var filePath = "/common/lang/";
    appcommon.initLanguage(params.l, filePath);
  }


  var MASTER_TABLE = "bcssteam_workingPrinciple";


  // Call 'onLoad' method from the Interface with params as the argument
  var onLoadRes = null;
  if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onLoad)
    onLoadRes = getWorkingPrincipleInterface.onLoad(params);

  // Check if 'onLoad' override is true
  if (onLoadRes && onLoadRes.override === true) {
    if (onLoadRes.resp) {
      if (onLoadRes.resp.code) {
        respObj = onLoadRes.resp;
      } else {
        respObj.code = 500;
        respObj.msg = Strings.SERVER_ERROR;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("Unexpected server error when retrieving the workingprinciple - " + paramStr);
      }
    }
  } else {

    // Calling 'beforeData' method from Interface and passing params as argument
    var beforeDataRes = null;
    if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.beforeData)
      beforeDataRes = getWorkingPrincipleInterface.beforeData(params);

    // Check if 'override' is true
    if (beforeDataRes && beforeDataRes.override === true) {
      //Sending request to ds client
      if (beforeDataRes.resp) {
        if (beforeDataRes.resp.code) {
          respObj = beforeDataRes.resp;
        } else {
          respObj.code = 500;
          respObj.msg = Strings.SERVER_ERROR;
          if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
            respObj = getWorkingPrincipleInterface.onError(respObj);
        }
      }
    } else {
      if (beforeDataRes && beforeDataRes.params)
        params = beforeDataRes.params;

      //Only if params is there
      if (params) {

        var queryParams = {
          "cols": ["master_name", "master_data", "edited_by", "edited_on"],
          "filter": [{
            "col": "master_name",
            "op": "=",
            "val": MASTER_TABLE
          }]
        };


        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.beforeExecute)
          queryParams = getWorkingPrincipleInterface.beforeExecute(queryParams, "query");

        //Sending request to ds client
        respObj = dsclientUtil.execute(queryParams, "BCSSteam", "BCSSteam_combined_master", "query");
        if (respObj.code == 200) {
          var respDataArr = respObj.data;
          if (respDataArr.length === 0 && DEFAULT_DATA.length > 0) {
            respObj = setDefaultMasterData(DEFAULT_DATA);
          }
        }
      } else {
        respObj.code = 400;
        respObj.msg = Strings.READ_WORKINGPRINCIPLE_ERROR;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
      }
    }

    switch (respObj.code) {
      case 200:
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.afterData)
          respObj.data = getWorkingPrincipleInterface.afterData(respObj.data);
        respObj.msg = Strings.READ_WORKINGPRINCIPLE_SUCCESS;
        break;
      case 400:
        respObj.msg = Strings.READ_WORKINGPRINCIPLE_ERROR;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("Unable to create the 'workingprinciple' - " + paramStr);
        break;
      case 403:
        respObj.msg = Strings.ACCESS_DENIED;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("User access denied when retrieving the 'workingprinciple' - " + paramStr);
        break;
      case 500:
        respObj.msg = Strings.SERVER_ERROR;
        if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
          respObj = getWorkingPrincipleInterface.onError(respObj);
        console.error("Unexpected server error when retrieving the 'workingprinciple' - " + paramStr);
        break;
    }

  }


  $g.response.headers["content-type"] = "application/json";
  $g.response.status = respObj.code;
  $g.response.body = JSON.stringify(respObj);

} catch (e) {

  //Error response object
  var errorRespObj = {
    status: 500,
    message: Strings.SERVER_ERROR + " - " + e.message,
    stack: e.stack
  };
  if (getWorkingPrincipleInterface && getWorkingPrincipleInterface.onError)
    errorRespObj = getWorkingPrincipleInterface.onError(errorRespObj);
  console.error("Unexpected server error when creating the 'workingPrinciple' - " + paramStr + "-" + errorRespObj.message);


  $g.response.headers["content-type"] = "application/json";
  $g.response.status = errorRespObj.status;
  $g.response.body = JSON.stringify(errorRespObj);

}