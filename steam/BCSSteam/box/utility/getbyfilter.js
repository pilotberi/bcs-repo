/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Wed Jan 14 2026 16:39:16 GMT+0530 (India Standard Time)
	Description : Query Service for utility
	WARNING : DO NOT MODIFY THIS FILE
*/

//External library
var dsclientUtil = require('dsclient');


//Internal library
var Strings = require("../common/strings.js");
var appcommon = require("../common/common.js");
var getUtilityByFilterInterface = require("getbyfilterinterface.js");

try {

  //Setting cache as null
  $g.response.headers["Cache-Control"] = "max-age=0";
  $g.response.headers["Cache-Control"] = "no-store";


  //Success response object
  var respObj = {
    code: 200,
    msg: Strings.READ_BCSSTEAM_UTILITY_GETUTILITYBYFILTER_SUCCESS
  };


  //Checking whether the request is in query or body
  var params = appcommon.processParams($g.request);
  var paramStr = JSON.stringify(params);

  //check for Language setup 
  if (params && params.l) {
    var filePath = "/common/lang/";
    appcommon.initLanguage(params.l, filePath);
  }


  // Call 'onLoad' method from the Interface with params as the argument
  var onLoadRes;
  if (getUtilityByFilterInterface) {
    onLoadRes = getUtilityByFilterInterface.onLoad(params);
  }
  // Check if 'onLoad' override is true
  if (getUtilityByFilterInterface && onLoadRes && onLoadRes.override === true) {
    if (onLoadRes.resp) {
      if (onLoadRes.resp.code) {
        respObj = onLoadRes.resp;
      } else {
        respObj.code = 500;
        respObj.msg = Strings.SERVER_ERROR;
        if (getUtilityByFilterInterface)
          respObj = getUtilityByFilterInterface.onError(respObj);
        console.error("Unexpected server error when retrieving the utility - " + paramStr);
      }
    }
  } else {

    // Calling 'beforeData' method from Interface and passing params as argument
    var beforeDataRes;
    if (getUtilityByFilterInterface) {
      beforeDataRes = getUtilityByFilterInterface.beforeData(params);
    }
    // Check if 'override' is true
    if (getUtilityByFilterInterface && beforeDataRes && beforeDataRes.override === true) {
      //Sending request to ds client
      if (beforeDataRes.resp) {
        if (beforeDataRes.resp.code) {
          respObj = beforeDataRes.resp;
        } else {
          respObj.code = 500;
          respObj.msg = Strings.SERVER_ERROR;
          respObj = getUtilityByFilterInterface.onError(respObj);
        }
      }
    } else {
      if (getUtilityByFilterInterface && beforeDataRes.params)
        params = beforeDataRes.params;

      //Only if params is there
      if (params) {

        //Query Params
        var getUtilityByFilterQueryParams = {};

        getUtilityByFilterQueryParams.cols = ["sfm_code_id", "value", "reason", "record_date", "remarks", "created_by", "created_on", "modified_by", "modified_on"];
        getUtilityByFilterQueryParams.filter = [];

        if (params.sfm_code_id && params.sfm_code_id != 'all') {
          getUtilityByFilterQueryParams.filter.push({
            "col": "sfm_code_id",
            "op": "=",
            "val": params.sfm_code_id
          });
        }
        if (params.start_date) {
          getUtilityByFilterQueryParams.filter.push({
            "col": "record_date",
            "op": ">=",
            "val": parseInt(params.start_date)
          });
        }
        if (params.end_date) {
          getUtilityByFilterQueryParams.filter.push({
            "col": "record_date",
            "op": "<=",
            "val": parseInt(params.end_date)
          });
        }








        if (getUtilityByFilterInterface) {
          getUtilityByFilterQueryParams = getUtilityByFilterInterface.beforeExecute(getUtilityByFilterQueryParams);
        }

        var countRespObj = null;

        if (params.offset || params.limit)
          countRespObj = dsclientUtil.execute(getUtilityByFilterQueryParams, "BCSSteam", "BCSSteam_utility", "count");

        //Setting offset and limit after count query
        if (params.offset)
          getUtilityByFilterQueryParams.offset = params.offset;

        if (params.limit)
          getUtilityByFilterQueryParams.limit = params.limit;

        //Sending request to ds client
        respObj = dsclientUtil.execute(getUtilityByFilterQueryParams, "BCSSteam", "BCSSteam_utility", "query");

        if (countRespObj)
          respObj.count = ((countRespObj.code == 200) && (countRespObj.data) && (countRespObj.data.count)) ? countRespObj.data.count : -1;

      } else {
        respObj.code = 400;
        respObj.msg = Strings.READ_BCSSTEAM_UTILITY_ERROR;
      }
    }


    switch (respObj.code) {
      case 200:
        if (getUtilityByFilterInterface)
          respObj.data = getUtilityByFilterInterface.afterData(respObj.data);
        respObj.msg = Strings.READ_BCSSTEAM_UTILITY_GETUTILITYBYFILTER_SUCCESS;
        break;
      case 400:
        respObj.msg = Strings.READ_BCSSTEAM_UTILITY_GETUTILITYBYFILTER_ERROR;
        if (getUtilityByFilterInterface)
          respObj = getUtilityByFilterInterface.onError(respObj);
        console.error("Unable to retrieve the utility - " + paramStr);
        break;
      case 403:
        respObj.msg = Strings.ACCESS_DENIED;
        if (getUtilityByFilterInterface)
          respObj = getUtilityByFilterInterface.onError(respObj);
        console.error("User access denied when retrieving the utility - " + paramStr);
        break;
      case 500:
        respObj.msg = Strings.SERVER_ERROR;
        if (getUtilityByFilterInterface)
          respObj = getUtilityByFilterInterface.onError(respObj);
        console.error("Unexpected server error when retrieving the utility - " + paramStr);
        break;
    }

  }


  $g.response.headers["content-type"] = "application/json";
  $g.response.status = respObj.code;
  $g.response.body = JSON.stringify(respObj);

} catch (e) {

  //Error response object
  var errorRespObj = {
    status: 500,
    message: Strings.SERVER_ERROR + " - " + e.message,
    stack: e.stack
  };
  if (getUtilityByFilterInterface) {
    errorRespObj = getUtilityByFilterInterface.onError(errorRespObj);
  }
  console.error("Unexpected server error when retrieving the utility - " + paramStr + "-" + errorRespObj.message);


  $g.response.headers["content-type"] = "application/json";
  $g.response.status = errorRespObj.status;
  $g.response.body = JSON.stringify(errorRespObj);

}