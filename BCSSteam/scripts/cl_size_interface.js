/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Wed Jan 07 2026 10:56:54 GMT+0530 (India Standard Time)
	Description : Combine Master Ui Interface for size
	WARNING : DO NOT MODIFY THE GENERATED INTERFACE METHOD NAME OR ARGUMENTS
*/
//var regex = /^(0|[1-9][0-9]*)(\.[0-9]*)?$/;   //not allows zero in front
var regex = /^[0-9]+(\.[0-9]*)?$/;



if (typeof TenantSizeInterface === 'undefined')
	TenantSizeInterface = {};

var SizeInterface = {
	loaded : false,
	onLoad: function() {

		document.querySelector("title").innerHTML = "BCS Steam";
		document.querySelector("span").innerHTML = "BCS Steam";


		if (TenantSizeInterface && TenantSizeInterface.onLoad)
			return TenantSizeInterface.onLoad();

	},

	onBeforeLoad: function() {
		//Custom code goes here


		if (TenantSizeInterface && TenantSizeInterface.onBeforeLoad)
			return TenantSizeInterface.onBeforeLoad();
		return true;
	},

	onAfterLoad: function(isSuccessful, dataArr) {
		//custom code goes here
		document.querySelector("td[title='Size']").innerHTML = "Size (inch)";

		SizeInterface.loaded = true;

		if (TenantSizeInterface && TenantSizeInterface.onAfterLoad)
			return TenantSizeInterface.onAfterLoad(isSuccessful, dataArr);
		return dataArr;
	},

	onBeforeData: function(svcName, params) {
		//custom code goes here

		if (TenantSizeInterface && TenantSizeInterface.onBeforeData)
			return TenantSizeInterface.onBeforeData(svcName, params);
		return params;
	},

	onAfterData: function(svcName, dataSources) {
		//custom code goes here

		if (TenantSizeInterface && TenantSizeInterface.onAfterData)
			return TenantSizeInterface.onAfterData(svcName, dataSources);
		return dataSources;
	},

	onBeforeSave: function(dataObj) {
		//custom code here

		//check duplicate 
		if (dataObj.master_data.length !== 0) {

			const sheetData = editorSheet.getData();
			const sizeMap = new Map(); 
			const duplicates = new Map(); 
			const invalidSize = new Map();

			for (let row = 0; row < sheetData.length; row++) {
				const size = sheetData[row][1]; // size column

				if (!size || size.trim() === "") continue;

				const normalizedSize = size.trim();

				if (!sizeMap.has(normalizedSize)) {
					sizeMap.set(normalizedSize, [row + 1]);
				} else {
					sizeMap.get(normalizedSize).push(row + 1);
					duplicates.set(normalizedSize, sizeMap.get(normalizedSize));
				}


				//invalid size checking
				if (!regex.test(normalizedSize)) {
					if (!invalidSize.has(normalizedSize)) {
						invalidSize.set(normalizedSize, [row + 1]);
					} else {
						invalidSize.get(normalizedSize).push(row + 1);
					}
				}

			}

			if (duplicates.size > 0) {

				var alertText = '<p>' + Strings.DUPLICATE_SIZE_ERROR_1 + '</p>';
				alertText += '<ol class="size_prompt_error">';
				duplicates.forEach((rows, size) => {
					alertText +='<li>' + 	"'"+size+"'" +  ' ' + Strings.DUPLICATE_SIZE_ERROR_2 + ' ' + rows.join(", ") + '</li>';
				});
				alertText += '</ol>';	

				s_info(Strings.VALIDATION_ERROR_TITLE,alertText.trim(),dlgOptions);
				return false;
			}

			if (invalidSize.size > 0) {
				let alertText = '<p>' + Strings.INVALID_SIZE_ERROR_1 + '</p>';
				alertText += '<ol class="size_prompt_error">';

				invalidSize.forEach((rows, size) => {
					alertText += '<li>' + "'"+size+"'" + ' ' + Strings.INVALID_SIZE_ERROR_2 + ' ' + rows.join(", ") + '</li>';
				});

				alertText += '</ol>';

				s_info(Strings.VALIDATION_ERROR_TITLE, alertText.trim(), dlgOptions);
				return false;
			}

		}


		if (TenantSizeInterface && TenantSizeInterface.onBeforeSave)
			return TenantSizeInterface.onBeforeSave(dataObj);
		return dataObj;
	},

	onAfterSave: function(isSuccessful, dataObj) {
		//Custom code here
		if(dataObj.err_code === 422){
			if(dataObj.refFlag === true){
				let alertText = '<p>' + Strings.FOREIGN_REFERENCE_EXIST_ON_SIZE + '</p>';
				alertText += '<ol class="size_prompt_error">';
				dataObj.deletedWithRefArr.forEach(item => {
					alertText += '<li>' + "'" + item.size + "'" + '</li>';
				});
				alertText += '</ol>';
				s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, alertText, dlgOptions);
			}

			if(dataObj.deletedDup === true && dataObj.refFlag === false ){
				s_toast(Strings.SAVE_SIZE_TOAST_SUCCESS);
				//s_info(Strings.STEAMFLOWMETER_ERROR_TITLE, Strings.DELETED_DUPLICATE_WP_SAME_NAME , dlgOptions);
			}

			clearSheet();

			for (var i = 0; i < dataObj.data.length; i++) {
				var delObj = dataObj.data[i];
				var rowId = i + 1;
				editorSheet.setValue('A' + rowId, delObj.id, true);
				editorSheet.setValue('B' + rowId, delObj.size, true);
			}
			return false;
		}


		if (TenantSizeInterface && TenantSizeInterface.onAfterSave)
			return TenantSizeInterface.onAfterSave(isSuccessful, dataObj);
		return dataObj;
	},

	onSheetChanged: function(instance, cell, col, row, value) {
		if (SizeInterface.loaded) {

			if (col === 1 || col === "1") {
				const formattedValue = SizeInterface._formatToTwoDecimals(value || "");
				if (formattedValue !== value) {
					editorSheet.setValue('B' + (Number(row) + 1), String(formattedValue), true);
					return; 
				}
			}

			const sheetData = editorSheet.getData();

			//clear the color
			for (let idx = 1; idx <= sheetData.length; idx++) {
				const bCell = instance.jspreadsheet.getCell(`B${idx}`);
				if (bCell) {
					SizeInterface._removeErrColor(bCell);
					bCell.removeAttribute("title");
				}
			}

			// add color if not a valid format
			for (let r = 0; r < sheetData.length; r++) {
				const val = sheetData[r][1];
				const currentCell = instance.jspreadsheet.getCell(`B${r + 1}`);
				if (val && !regex.test(val) && currentCell) {
					SizeInterface._addErrColor(currentCell);
					currentCell.setAttribute("title", "Invalid size format");
				}
			}

			//check for duplicate
			const duplicateResults = common_util.checkDuplicate(sheetData, editorSheet);
			const duplicates = duplicateResults.duplicates;

			if (duplicates && duplicates.size > 0) {
				duplicates.forEach((rows, val) => {
					rows.forEach((rowIdx) => {
						const dupCell = instance.jspreadsheet.getCell(`B${rowIdx}`);
						if (dupCell) {
							SizeInterface._addErrColor(dupCell);
							dupCell.setAttribute("title", "This data already exists");
						}
					});
				});
			}

		}

		if (TenantSizeInterface && TenantSizeInterface.onSheetChanged)
			return TenantSizeInterface.onSheetChanged(instance, cell, col, row, value);
		return true;
	},

	_formatToTwoDecimals: function (value) {


		if (!regex.test(value)) {
			return value; // return if invalid numeric value
		}

		if (!value.includes('.')) {
			return value + '.00';
		}

		const parts = value.split('.');
		const decimals = parts[1];

		if (decimals.length === 0) {
			return value + '00';
		}

		if (decimals.length === 1) {
			return value + '0';
		}

		if (decimals.length > 2) {
			return Number(value).toFixed(2);
		}

		return value; // return if valid size with 2 decimals
	},

	_addErrColor: function(cell){
		cell.classList.add("error_value");
	},

	_removeErrColor: function(cell){
		cell.classList.remove("error_value");
	},

};

