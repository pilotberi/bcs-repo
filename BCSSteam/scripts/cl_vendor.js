/*
	Generated By : Steps Code Generator.
	Version : 2024
	Generated On : Thu Jan 22 2026 19:21:57 GMT+0530 (India Standard Time)
	Description : Client Logic for BCSSteam ListDetails.
	Warning : DON"T TOUCH THE BASE CODE 
*/


var currAppName = 'BCSSteam';
var isCustom = false;
var msCheck = 0;
var loadCheck = 0;
var contentView, formView, formClose;
var vendorTable;


var vendorBusiness_partner_idZoom;
var createVendorBtn, addVendorBtn, cancelBtns, duplicateVendorBtn, deleteVendorBtn, editVendorBtn, importVendorBtn, aiAssistantVendorBtn;
var cancelCreateBtn, cancelUpdateBtn;
var selectedRow;
var userObj;
var scrypto;
var params;
var rowData;
var backBtn;
var tourMsgs = [];
var primaryArr = [];
var chunkSize = 30;
var currentIndex = 0;
var offset = 0;
var limit = 100;
var limCookieSet = null;
var offCookieSet = null;
var loadMore, loadAll;
var actionsSelect;


var language = "EN";
var dlgOptions = {
  "STR_OK": "OK",
  "STR_CANCEL": "Cancel",
  "STR_YES": "Yes",
  "STR_NO": "No"
};

var filterVendorBtn, filterActionsVendorBtn;
var selectFilters;
var searchOptsTables = [];
var filterContent;

var numberFormat, currencyFormat, onlyNumRegExp, localeCode = null,
  currency = null;
var localeObj = {};
onlyNumRegExp = new RegExp(/^[0-9]*.?[0-9]*$/);

var actionsSelectOptionsArr = []
var vendorBusiness_partner_id, vendorIsactive;
var businessPartnerArr;
var business_partner_idPnl, business_partner_idAddBtn, business_partner_idMobBackBtn, assignBusiness_partner_idBtn, cancelBusiness_partner_idBtn, searchBusiness_partner_idBox, business_partner_idTable;
var selectedBusiness_partner_idId;

var dataSources = {};
var customDtOpns = {};
$(document).ready(onApplicationReady);


function onApplicationReady() {
  var qStr = window.location.search;

  if (qStr) {
    params = clCommon.getParams(qStr.substring(1, qStr.length));
  }

  setMenu(document.getElementById('sideMenu'), 'bcssteam_vendor');


  clCommon.showLoader('svcProgress');
  var url = "/sauth/getuser";
  clCommon.getSvc(true, url, onUser, onUserError);
}


function initControls() {
  contentView = document.getElementById('contentView');
  formView = document.getElementById('vendorDetailsPanel');
  formClose = document.getElementById('formClose');
  if (clCommon.isMobile()) {
    clCommon.hide(formClose);
    hideForm();
  } else {
    var formContent = document.querySelector('.form-content-holder');
    formContent.classList.add('expand');
  }

  cancelCreateBtn = document.getElementById('cancelCreateBtn');
  cancelUpdateBtn = document.getElementById('cancelUpdateBtn');

  filterContent = document.getElementById("filterContent");
  selectFilters = document.getElementById("selectFilters");

  // Set initial state of Cancel buttons based on Cookie
  var isFullCookie = clCommon.getCookie("bcssteam_full_view");
  if (isFullCookie === "true") {
    clCommon.show(cancelCreateBtn);
    clCommon.show(cancelUpdateBtn);
  } else {
    clCommon.hide(cancelCreateBtn);
    clCommon.hide(cancelUpdateBtn);
  }

  vendorBusiness_partner_id = document.getElementById('vendorBusiness_partner_id');
  vendorIsactive = document.getElementById('vendorIsactive');

}


function initTable() {
  var dtOpns = { //Funtion to display datatable
    data: [], //Sort array and set data
    scrollY: (document.querySelector(".content-list").offsetHeight - 200) + "px",
    autoWidth: false,
    columns: [{
      data: 'business_partner_id',
      'bSortable': true,
      'type': 'business_partner_id',
      render: renderData,
    }, {
      data: 'received_amount',
      render: renderData,
    }],
    "columnDefs": [],
    "orderClasses": false,
    "language": Strings.DATA_TABLE_LANG,
    "order": [], //to display the array sorted
    "deferRender": true
  };

  if (clCommon.isMobile())
    delete dtOpns.scrollY;

  if (Object.keys(customDtOpns).length > 0) {
    for (var opn in customDtOpns) {
      dtOpns[opn] = customDtOpns[opn];
    }
  }
  vendorTable = $('#tableHolder').DataTable(dtOpns);


  jQuery.fn.dataTableExt.oSort["business_partner_id-desc"] = function(x, y) {
    //return getRank(x) < getRank(y);
    var tElem = document.createElement('div');
    tElem.innerHTML = x + y;
    var sX = parseInt(tElem.firstChild.getAttribute("ddval"));
    var sY = parseInt(tElem.lastChild.getAttribute("ddval"));
    var rVal = (sX < sY) ? 1 : -1;
    if (sX === sY)
      rVal = 0;
    delete tElem;
    return rVal;
  };

  jQuery.fn.dataTableExt.oSort["business_partner_id-asc"] = function(x, y) {
    //return getRank(x) > getRank(y);
    var tElem = document.createElement('div');
    tElem.innerHTML = x + y;
    var sX = parseInt(tElem.firstChild.getAttribute("ddval"));
    var sY = parseInt(tElem.lastChild.getAttribute("ddval"));
    var rVal = (sX > sY) ? 1 : -1;
    if (sX === sY)
      rVal = 0;
    return rVal;
  }

  if (!clCommon.isMobile()) {
    resizeTable();

    window.onresize = function(e) {
      resizeTable();
    };
  }
}

function renderData(data, type, row, meta) {
  var dataDisplay;
  if (VendorInterface && VendorInterface.renderData)
    dataDisplay = VendorInterface.renderData(data, type, row, meta);
  if (!dataDisplay || dataDisplay == null || dataDisplay == undefined) {
    dataDisplay = data;
  }

  var isFullCookie = clCommon.getCookie("bcssteam_full_view");

  if (!clCommon.isMobile() && isFullCookie === "true" && meta.col === 0) {
    return '<a href="javascript:void(0);" class="open-full-view-link">' + dataDisplay + '</a>';
  }

  if (!clCommon.isMobile()) resizeTable();

  return dataDisplay;
}

//To set the size of the table dynamically.
function resizeTable() {
  //Dont resize when listview is hidden
  if (contentView.classList.contains("hide")) {
    return;
  }
  setTimeout(setTableHeightOnResize, 50);

}

function setTableHeightOnResize() {
  // Get the height of the content list element
  var contListOffHeight = document.querySelector('.content-list').offsetHeight;

  // Get the height of the list head
  var listHeadOffHeight = document.querySelector('.listHead').offsetHeight;

  // Calculate and set the height of the list holder by subtracting the list head height from the content list height
  var listHolder = document.querySelector(".list-holder");
  listHolder.style.height = contListOffHeight - listHeadOffHeight + "px";

  // Get the heights of various DataTable elements
  var dtScrHeadClientHeight = document.querySelector('.dataTables_scrollHead').clientHeight; // DataTable scroll head height
  var dtFiltOfHeight = document.querySelector('.dataTables_filter').offsetHeight; // DataTable filter height
  var dtPagenateHeight = document.querySelector('.dataTables_paginate').offsetHeight; // DataTable pagination height

  // Set an additional offset to prevent the table from being too close to the bottom of the screen
  var addlOffSet = 10;

  // Calculate and set the height of the DataTable scroll body by subtracting the heights of the scroll head, filter, and pagination elements
  var scrollBodyHeight = listHolder.offsetHeight - dtScrHeadClientHeight - dtPagenateHeight - dtFiltOfHeight - addlOffSet;
  document.querySelector('div.dataTables_scrollBody').style.height = scrollBodyHeight + "px";

  // Adjust the DataTable columns after resizing
  vendorTable.columns.adjust();
}



function registerEventListeners() {

  filterVendorBtn = document.getElementById('filterVendorBtn');
  filterVendorBtn.addEventListener('click', onFilterVendorBtnClick);

  formClose.addEventListener('click', toggleFullview);

  cancelBtns = document.querySelectorAll('.cancel-form-btn');
  cancelBtns.forEach(function(btn) {
    btn.addEventListener('click', onFormBackBtnClick);
  });
  if (clCommon.isMobile()) {
    cancelBtns = document.querySelectorAll('.cancel-form-btn');
    cancelBtns.forEach(function(btn) {
      clCommon.hide(btn);
    });
  }

  filterActionsVendorBtn = document.getElementById('filterActionsVendorBtn');
  filterActionsVendorBtn.addEventListener('click', onFilterVendorBtnClick);

  createVendorBtn = document.getElementById('createVendorBtn');
  createVendorBtn.addEventListener('click', onCreateVendorBtnClick);

  editVendorBtn = document.getElementById('updateVendorBtn');
  editVendorBtn.addEventListener('click', onUpdateVendorBtnClick);

  addVendorBtn = document.getElementById('addVendorBtn');
  addVendorBtn.addEventListener('click', onAddVendorBtnClick);



  if (clCommon.isMobile()) {
    deleteVendorBtn = document.getElementById('deleteVendorMobBtn');
    clCommon.hide(document.getElementById('deleteVendorBtn'));
  } else {
    deleteVendorBtn = document.getElementById('deleteVendorBtn');
  }
  deleteVendorBtn.addEventListener('click', onDeleteVendorBtnClick);







  loadMore = document.getElementById("loadMore");
  loadMore.addEventListener('click', onToolBarBtnClick);

  loadAll = document.getElementById("loadAll");
  loadAll.addEventListener('click', onToolBarBtnClick);

  vendorBusiness_partner_id.addEventListener('change', onFieldChange);
  vendorBusiness_partner_id.addEventListener('focus', onFieldFocus);
  vendorBusiness_partner_id.addEventListener('blur', onFieldChange);

  vendorBusiness_partner_idZoom = document.getElementById('vendorBusiness_partner_idZoom');
  vendorBusiness_partner_idZoom.addEventListener('click', onToolBarBtnClick);


  business_partner_idPnl = document.getElementById("business_partner_idPnl");

  business_partner_idAddBtn = document.getElementById('business_partner_idAddBtn');
  business_partner_idAddBtn.addEventListener('click', onLookupAddBtnClick);

  business_partner_idMobBackBtn = document.getElementById('business_partner_idMobBackBtn');
  business_partner_idMobBackBtn.addEventListener('click', onBusiness_partner_idMobBackBtn);

  relateBusiness_partner_idBtn = document.getElementById('assignBusiness_partner_idBtn');
  relateBusiness_partner_idBtn.addEventListener('click', onRelateBusiness_partner_idBtn);

  cancelBusiness_partner_idBtn = document.getElementById('cancelBusiness_partner_idBtn');
  cancelBusiness_partner_idBtn.addEventListener('click', onCancelBusiness_partner_idBtn);

  searchBusiness_partner_idBox = document.getElementById('searchBusiness_partner_idBox');
  searchBusiness_partner_idBox.addEventListener('keyup', onSearchBusiness_partner_id);
  vendorIsactive.addEventListener('change', onFieldChange);
  vendorIsactive.addEventListener('focus', onFieldFocus);
  vendorIsactive.addEventListener('blur', onFieldChange);


  $('#tableHolder tbody').on('click', 'tr', onRowClick);
  $('#tableHolder tbody').on('click', '.open-full-view-link', onTableLinkClick);


  backBtn = document.getElementById('backBtn');
  backBtn.addEventListener('click', onFormBackBtnClick);

  if (clCommon.isMobile() && window.history && window.history.pushState) {
    window.addEventListener('popstate', function() {
      hideForm();
    });
  }

  if (clCommon.isMobile()) {
    clCommon.setCookie("bcssteam_full_view", "", -1);
    formView.classList.remove('fullview');
  }


  common_util.setSelectTitleOnChange();
}

function onTableLinkClick(e) {
  e.preventDefault();
  e.stopPropagation();
  var tr = $(this).closest('tr');
  if (!tr.hasClass('selected')) {
    tr.trigger('click');
  }
  toggleFullview(true);
}

function toggleFullview(forceState) {
  var isCurrentlyFull = formView.classList.contains('fullview');
  var shouldBeFull;

  if (typeof forceState === 'boolean') {
    shouldBeFull = forceState;
  } else {
    shouldBeFull = !isCurrentlyFull;
  }

  if (shouldBeFull) {
    // ENTER Full View 
    contentView.classList.add('hide');
    formView.classList.remove('hide');

    if (!clCommon.isMobile()) {
      formView.classList.add('fullview');
    }

    if (cancelCreateBtn) clCommon.show(cancelCreateBtn);
    if (cancelUpdateBtn) clCommon.show(cancelUpdateBtn);

    clCommon.setCookie("bcssteam_full_view", "true", 10);

    if (vendorTable) {
      vendorTable.rows().invalidate().draw(false);
      resizeTable();
    }
  } else {
    // EXIT Full View
    contentView.classList.remove('hide');
    formView.classList.remove('fullview');
    formView.classList.remove('hide');

    if (cancelCreateBtn) clCommon.hide(cancelCreateBtn);
    if (cancelUpdateBtn) clCommon.hide(cancelUpdateBtn);

    clCommon.setCookie("bcssteam_full_view", "", -1);

    if (vendorTable) {
      vendorTable.rows().invalidate().draw(false);
      resizeTable();
    }
  }

  // Handle Title Visibility
  var formTitle = document.getElementById('formTitleHeader');
  if (formTitle) {
    if (formView.classList.contains('fullview')) {
      formTitle.classList.remove('hide');
    } else {
      formTitle.classList.add('hide');
    }
  }

  //Handle Dynamic Field Layout (data-expand-class & data-normal-class)
  var expandFields = formView.querySelectorAll('[field]');

  if (expandFields.length > 0) {
    expandFields.forEach(function(el) {
      var expandStr = el.getAttribute('data-expand-class');
      var normalStr = el.getAttribute('data-normal-class');

      var expandClasses = expandStr ? expandStr : [];
      var normalClasses = normalStr ? normalStr: [];

      if (shouldBeFull) {
        el.className = expandClasses;
      } else {
        el.className = normalClasses;
      }
    });
  }
}


function openLookupView(panelElement) {
  clCommon.hide(formView);
  clCommon.show(panelElement);

  if (!clCommon.isMobile() && formView.classList.contains('fullview')) {
    panelElement.classList.add('fullview');
    contentView.classList.add('hide');
  }
}

function closeLookupView(panelElement) {
  clCommon.hide(panelElement);
  panelElement.classList.remove('fullview');

  clCommon.show(formView);
}

function onOptionClick(opObj, containerId, changedElementId) {
  clCommon.show(selectFilters);
  clCommon.hide(document.getElementById(containerId));

  var id = opObj.getAttribute("optnId");
  document.getElementById(changedElementId).value = id;


}

function onFilterVendorBtnClick(e) {
  clCommon.show(selectFilters);

  const elements = document.querySelectorAll('[id$="OptsTableContainer"]');

  const ids = Array.from(elements).map(el => el.id);

  for (var id in ids) {
    clCommon.hide(document.getElementById(ids[id]));
  }

  openFilterPopup(e);
}

function openFilterPopup(event) {
  var bodyEl = filterContent;

  var options = {
    onSearch: function() {}
  };

  var buttons = [{
      label: "Cancel",
      handler: function(onPrompt) {
        return function(e) {
          clCommon.hide(filterContent);

          this.setAttribute("pressed", "cancel"),
            onPrompt && onPrompt.call(this, null);
        };
      },
      attributes: {
        "data-bs-dismiss": "modal"
      }
    },
    {
      label: "Apply",
      handler: (searchHandler = options.onSearch,
        function(e) {
          clCommon.hide(filterContent);
          loadVendorData();
        }),
      attributes: {
        "data-bs-dismiss": "modal"
      }
    }
  ];

  var searchPopup = s_dialog('searchPopup', "Options", bodyEl, buttons, options, dlgOptions);
  searchPopup.show();
  clCommon.show(filterContent);

  if (clCommon.isMobile()) {
    if (event.target.id === 'filterVendorBtn') {
      activateTab('nav-filter', 'nav-action');
    } else if (event.target.id === 'filterActionsVendorBtn') {
      activateTab('nav-action', 'nav-filter');
    }
  } else {
    // Desktop default (assuming you don't need the clCommon hide/show logic here based on your original code)
    document.getElementById('nav-filter-tab').click();
  }
}

function activateTab(activeId, inactiveId) {
  // Handle the "Active" Tab
  clCommon.show(document.getElementById(activeId + '-tab'));
  clCommon.show(document.getElementById(activeId));
  document.getElementById(activeId + '-tab').classList.add('active');
  document.getElementById(activeId).classList.add('active', 'show');

  // Handle the "Inactive" Tab
  clCommon.hide(document.getElementById(inactiveId + '-tab'));
  clCommon.hide(document.getElementById(inactiveId));
  document.getElementById(inactiveId + '-tab').classList.remove('active');
  document.getElementById(inactiveId).classList.remove('active', 'show');
}


/*
	Function is called during onload event
*/
function onUser(resp) {
  clCommon.hideLoader('svcProgress');

  if (resp.code !== 200)
    redirect("/");

  userObj = resp.user;

  document.getElementById('userName').innerHTML = (userObj.firstname ? userObj.firstname : userObj.username);
  clCommon.initLanguage(userObj.realm_lang, function() {
    dlgOptions.STR_OK = clCommon.getString("OK", "OK");
    dlgOptions.STR_CANCEL = clCommon.getString("CANCEL", "Cancel");
    dlgOptions.STR_YES = clCommon.getString("YES", "Yes");
    dlgOptions.STR_NO = clCommon.getString("NO", "No");

    if (typeof VendorInterface === 'undefined')
      VendorInterface = null;

    if (VendorInterface && VendorInterface.onLoad)
      VendorInterface.onLoad();

    initControls();
    initTable();
    initSearchTable();

    initBusiness_partner_idTable();


    registerEventListeners();
    setActionsSelectOptions();

    scrypto = new SimpleCrypto(userObj.realm_name);

    var userLocale = userObj.realm_locale ? userObj.realm_locale : localeObj;

    localeCode = userLocale.code ? userLocale.code : "en-IN";
    currency = userLocale.currency ? userLocale.currency : "INR";

    numberFormat = new Intl.NumberFormat(localeCode, {
      style: "decimal"
    });
    currencyFormat = new Intl.NumberFormat(localeCode, {
      style: "currency",
      currency: (typeof slocale !== 'undefined') ? slocale.getLocaleInfo(localeCode).currency_code : currency,
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });


    clCommon.showLoader('svcProgress');

    var customAppName = clCommon.getCustomAppName();
    var url = customAppName ? ("/steps/hq/" + customAppName + "/common/appsvc?is_custom=true") : (isCustom ? "./common/appsvc?is_custom=true" : "./common/appsvc");

    //To handle the across app integration
    if (params && params.app) {
      // If the URL already has a "?" in it, append with "&", otherwise with "?"
      url += (url.includes("?") ? "&" : "?") + "app=" + params.app;
    }


    clCommon.getSvc(true, url, onAppUserInfo, onAppUserInfoError);
  });
}

function initSearchTable() {
  for (var p = 0; p < searchOptsTables.length; p++) {
    var tableVarName = searchOptsTables[p]; // "productFilterOptsTable"
    var tableId = "#" + tableVarName; // "#productFilterOptsTable"

    // Create datatable instance
    var dt = $(tableId).DataTable({
      paging: false,
      info: false,
      autoWidth: false,
      columns: [{
          data: 'radio'
        },
        {
          data: 'optionName'
        }
      ],
      columnDefs: [{
        width: "25px",
        targets: 0
      }]
    });

    dt.table().node().classList.remove('nowrap');

    // Assign instance to the correct global variable
    window[tableVarName] = dt;
  }
}

function setActionsSelectOptions() {
  if (!document.getElementById('actionsSelectTable'))
    return;

  var tableId = "#" + "actionsSelectTable";


  // Create datatable instance
  var actionsTable = $(tableId).DataTable({
    paging: false,
    info: false,
    autoWidth: false,
    columns: [{
        data: 'radio'
      },
      {
        data: 'optionName'
      }
    ],
    columnDefs: [{
      width: "25px",
      targets: 0
    }]
  });

  actionsTable.table().node().classList.remove('nowrap');

  var optionsArr = [];
  for (var d in actionsSelectOptionsArr) {
    var optObj = actionsSelectOptionsArr[d];
    var tObj = {
      "optionName": '<label for="' + optObj.idName + '">' + optObj.displayName + '</label>',
      "radio": '<input type="radio" ' +
        'id="' + optObj.idName + '" ' +
        'name="optionName" ' +
        'onclick="onChangeOfActionSelect(this)">'
    };
    optionsArr.push(tObj);
  }

  actionsTable.clear().draw();
  actionsTable.rows.add(optionsArr).draw();
}

function capitalizeAndUnderscore(str) {
  // Trim the string, replace spaces with underscores, and convert to uppercase
  return str.trim().replace(/s+/g, '_').toUpperCase();
}

function loadMasters() {
  getAllBusinessPartner();

  masterWs = 1;
  callOnLoadFunction();
}

function callOnLoadFunction() {
  if (msCheck == masterWs) {
    loadData();
    msCheck = 0;
    return;
  }
  setTimeout(() => {
    callOnLoadFunction();
  }, 300);
}

function findOnlyUniques(array) {
  var seen = {};
  var uniqueArr = [];

  // Step 1: Remove duplicates by _sid
  for (var i = 0; i < array.length; i++) {
    var item = array[i];
    if (!seen[item._sid]) {
      seen[item._sid] = true;
      uniqueArr.push(item);
    }
  }

  return uniqueArr;
}

function loadLimFunction(lim) {
  if (lim) {
    offset += limit;
    limit = lim;
  } else {
    offset = 0;
    limit = 0;
  }

  clCommon.setCookie("VendorOffset", offset, 10);
  clCommon.setCookie("VendorLimit", limit, 10);

  loadVendorData();
}


/*
	Function is called during onload event
	This function invoked on error response
*/
function onUserError(resp) {
  clCommon.hideLoader('svcProgress');
  redirect("/sauth/login.html");
}


/*
Function is called to redirect to the url
*/
function redirect(url) {
  window.location.href = url + (language !== "EN" ? ("?l=" + language) : "");
}


function getAllBusinessPartner(isFieldChange, changedField) {


  Service.getAllBusinessPartner(function(isFldChange, changedFld) {
    return function(respObj) {

      if (respObj.code == 200) {
        businessPartnerArr = respObj.data;
        msCheck++;


        if (!dataSources.getAllBusinessPartner) {
          dataSources.getAllBusinessPartner = businessPartnerArr;
        }




        if (VendorInterface && VendorInterface.onBeforeLoad)
          dataSources = VendorInterface.onBeforeLoad(dataSources);
        if (dataSources == false) {
          return;
        }



        if (undefined && dataSources.getAllBusinessPartner && dataSources.getAllBusinessPartner.length > 1) {
          dataSources.getAllBusinessPartner = clCommon.sort(dataSources.getAllBusinessPartner, "name"); //Sort alphabetically
        }





        for (var t = 0; t < dataSources.getAllBusinessPartner.length; t++) {
          try {
            //decrypt response data
            dataSources.getAllBusinessPartner[t].name = scrypto.decrypt(dataSources.getAllBusinessPartner[t].name);
          } catch (e) {
            //ignore old unencrypted data
            dataSources.getAllBusinessPartner[t].name = dataSources.getAllBusinessPartner[t].name;
          }




        }



        if (VendorInterface && isFieldChange == true) {
          VendorInterface.onFieldChange(changedFld, dataSources);
        }
      }
    };
  }(isFieldChange, changedField));
}



/*
	Function is called during onload event on error response
*/
function onAppUserInfo(resp) {
  var noDataElem = document.getElementById("contentNoData");
  var dataElem = document.getElementById("contentData");

  clCommon.hideLoader('svcProgress');

  if (resp.code === 200) {
    if (resp.menuArr) {
      clCommon.show(dataElem);
      dataSources.menuArr = resp.menuArr;
      dataSources.roleArr = resp.roleArr;

      processMenu(resp.menuArr);

      clCommon.appendSystemRoles(document.getElementById('sideMenu'), userObj);



      loadMasters();
    } else {
      clCommon.show(noDataElem);
      clCommon.hide(dataElem);
    }
  } else {
    s_error(Strings.GET_APP_USER_INFO_ERROR_TITLE, Strings.APP_USER_MENU_ERROR, dlgOptions);
  }
}


/*
	Function is called during onload event on error response
*/
function onAppUserInfoError(resp) {
  clCommon.hideLoader('svcProgress');
  s_error(Strings.GET_APP_USER_INFO_ERROR_TITLE, Strings.APP_USER_MENU_ERROR, dlgOptions);
}

function showForm() {
  window.history.pushState('form', null, '#form');
  clCommon.hide(contentView);
  clCommon.show(formView);
}

function hideForm() {
  clCommon.show(contentView);
  clCommon.hide(formView);
  if (!clCommon.isMobile()) resizeTable();
}

function onFormBackBtnClick(e) {
  if (e) e.preventDefault();

  if (clCommon.isMobile()) {
    history.back();
    return;
  }

  var isFullCookie = clCommon.getCookie("bcssteam_full_view");
  clearForm();

  if (isFullCookie === "true") {
    contentView.classList.remove('hide');
    formView.classList.add('hide');
    formView.classList.add('fullview');
    if (selectedRow) {
      $(selectedRow).removeClass('selected');
      selectedRow = null;
    }
    deleteVendorBtn.classList.add('disabled');
  }

  if (!clCommon.isMobile()) resizeTable();
}




function loadData() {
  clCommon.showLoader('dataProgress');
  var beforeLoad = true;
  if (VendorInterface && VendorInterface.onBeforeLoad)
    beforeLoad = VendorInterface.onBeforeLoad(dataSources);

  if (beforeLoad == false) {
    return
  }
  svcCount = 1;
  loadMainVendorData();

  onAfterLoadFunction();
}

function loadMainVendorData() {
  clCommon.showLoader('dataProgress');
  checkAndLoadData();
  hideLoaderFn();
}


function onAfterLoadFunction() {
  if (VendorInterface && VendorInterface.onAfterLoad)
    VendorInterface.onAfterLoad(dataSources);
  clCommon.hideLoader('dataProgress');
  loadCheck = 0;
  return;
}


function hideLoaderFn() {
  clCommon.hideLoader('dataProgress');
  loadCheck = 0;
  return;
}

function checkAndLoadData() {
  var limitCookie = clCommon.getCookie("VendorLimit");
  var offsetCookie = clCommon.getCookie("VendorOffset");

  var limitVal = Number(limitCookie);
  var offsetVal = Number(offsetCookie);

  // Case 1: Load All - offset = 0 and limit = 0
  if (offsetVal === 0 && limitVal === 0 && limitCookie != "" && offsetCookie != "") {
    s_confirm(Strings.CONFIRM, Strings.CONFIRM_LOAD_ALL_PRT_1 + "?" + Strings.CONFIRM_LOAD_PRT_2, {
      STR_YES: dlgOptions.STR_YES,
      STR_NO: dlgOptions.STR_NO,
      onYes: function() {
        limCookieSet = 0;
        offCookieSet = 0;
        loadMore.classList.add('disabled');
        loadAll.classList.add('disabled');
        loadVendorData();
      },
      onNo: function() {
        offCookieSet = 0;
        limCookieSet = 100;
        loadVendorData();
      }
    });
    return;
  }

  // Case 2: Load 400 plus data threshold check
  if (offsetVal >= 400 && limitVal > 0) {
    s_confirm(Strings.CONFIRM, Strings.VALIDATION_COOKIE_LOAD_DATA + "?", {
      STR_YES: dlgOptions.STR_YES,
      STR_NO: dlgOptions.STR_NO,
      onYes: function() {
        offCookieSet = 0;
        limCookieSet = offsetVal + limitVal;
        loadVendorData();
      },
      onNo: function() {
        offCookieSet = 0;
        limCookieSet = 100;
        loadVendorData();
      }
    });
    return;
  } else if (limitCookie != "" && offsetCookie != "") {
    offCookieSet = 0;
    limCookieSet = offsetVal + limitVal;
  }

  // Default: load first 100
  loadVendorData();
}

function loadVendorData() {
  vendorTable.clear().draw();
  clCommon.showLoader("listProgress");

  if (limCookieSet != null) {
    offset = offCookieSet;
    limit = limCookieSet;
  }

  var params = [offset, limit, ];

  var onBeforeData = true;
  if (VendorInterface && VendorInterface.onBeforeData)
    onBeforeData = VendorInterface.onBeforeData(params, dataSources);


  if (onBeforeData) {
    params.push(function(resultObj) {
      clCommon.hideLoader("listProgress");
      var dataArr;
      var isSuccessful;
      if (resultObj.code == 200) { //On success response
        if (limCookieSet != null) {
          offset = limCookieSet == 0 ? 0 : (limCookieSet - 100);
          limit = 100;
          offCookieSet = null;
          limCookieSet = null;
        }
        dataArr = resultObj.data.concat(primaryArr);
        dataArr = findOnlyUniques(dataArr);
        isSuccessful = true;


        if (VendorInterface && VendorInterface.onAfterData)
          dataArr = VendorInterface.onAfterData(isSuccessful, dataArr, dataSources);

        onLoadSuccessResponse(dataArr);


        // Check Cookie
        var isFullCookie = clCommon.getCookie("budget_full_view");
        // Only auto-select first row if NOT mobile AND cookie is NOT set
        if (!clCommon.isMobile() && isFullCookie !== "true" && dataArr.length > 0) {
          var firstRow = $('#tableHolder tbody tr:eq(0)');
          if (firstRow) {
            firstRow.click(); //by default select first row
          }
        }

        // If cookie IS set, we ensure the form is hidden to show the table list
        else if (isFullCookie === "true") {
          contentView.classList.remove('hide');
          formView.classList.add('hide');
          formView.classList.add('fullview'); // Maintain state class for later logic

          // Ensure buttons are reset if needed
          deleteVendorBtn.classList.add('disabled');
        }
        dataSources.primary = dataArr;
        primaryArr = dataArr;
        if (resultObj.count) {
          if ((primaryArr.length == resultObj.count) || (resultObj.count == -1)) {
            loadMore.classList.add('disabled');
            loadAll.classList.add('disabled');
          }
        }

      } else { //On error response
        isSuccessful = false;

        if (VendorInterface && VendorInterface.onAfterData)
          dataArr = VendorInterface.onAfterData(isSuccessful, dataArr, dataSources);

        s_error(Strings.ERROR, Strings.ERROR_LOAD_VENDOR, dlgOptions);
      }
    });
    Service.getAllVendor.apply(this, params);
  }
  if (clCommon.isMobile()) {
    hideForm();
  }
}


function onLoadSuccessResponse(dataArr) {
  if (!dataArr || dataArr.length == 0) {
    clearForm();


    deleteVendorBtn.classList.add('disabled');
  }

  chunkSize = 30;
  currentIndex = 0;
  vendorTable.clear().draw();
  loadChunk(dataArr);

  var isFullCookie = clCommon.getCookie("bcssteam_full_view");

  if (!clCommon.isMobile() && isFullCookie === "true") {
    contentView.classList.remove('hide');
    formView.classList.add('hide');
    formView.classList.add('fullview');

    clCommon.show(cancelCreateBtn);
    clCommon.show(cancelUpdateBtn);
  }
}

function loadChunk(dataArr) {
  if (!dataArr || currentIndex >= dataArr.length) {
    return;
  }

  var chunk = dataArr.slice(currentIndex, currentIndex + chunkSize);
  for (var i = 0; i < chunk.length; i++) {



  }
  vendorTable.rows.add(chunk).draw(); // 'false' to not reset paging each time
  currentIndex += chunkSize;

  setTimeout(() => loadChunk(dataArr), 10); // adjust timeout as needed
}

function onChangeOfFilter(e) {



  offset = 0;
  limit = 100;

  clCommon.setCookie("VendorOffset", offset, 10);
  clCommon.setCookie("VendorLimit", limit, 10);

  primaryArr = [];
  loadMore.classList.remove('disabled');
  loadAll.classList.remove('disabled');

  const changedElement = e.target;
  const selectedType = changedElement.value;

  if (selectedType == 'search') {
    //TODO add logic for popup and setup options

    clCommon.hide(selectFilters);

    var optionsTbCont = changedElement.id + "OptsTableContainer";
    clCommon.show(document.getElementById(optionsTbCont));

    var title = "Search";

    const options = changedElement.querySelectorAll("option");
    var optnArr = [];
    options.forEach(opt => {
      const name = opt.textContent.trim();
      if (name !== "Search") {
        optnArr.push({
          id: opt.value,
          name: name
        });
      }
    });

    var optionsArr = [];
    for (var d in optnArr) {
      var optObj = optnArr[d];
      var tObj = {
        "optionName": '<label for="radio_' + optObj.id + '">' + optObj.name + '</label>',
        "radio": '<input type="radio" ' +
          'id="radio_' + optObj.id + '" ' +
          'name="optionName" ' +
          'optnId="' + optObj.id + '" ' +
          'onclick="onOptionClick(this, \'' + optionsTbCont + '\', \'' + e.target.id + '\')">'
      };
      optionsArr.push(tObj);
    }

    window[changedElement.id + "OptsTable"].clear().draw();
    window[changedElement.id + "OptsTable"].rows.add(optionsArr).draw();

    var onSearchCheck = true;
    if (VendorInterface && VendorInterface.onSearchChangeFilter) {
      onSearchCheck = VendorInterface.onSearchChangeFilter(e);
    }

  } else {
    var onChangeCheck = true;
    if (VendorInterface && VendorInterface.onChangeFilter)
      onChangeCheck = VendorInterface.onChangeFilter(e)
  }
}

function onChangeOfActionSelect(val) {
  var changedAction = val;
  var returnData = true;
  if (VendorInterface && VendorInterface.onChangeOfActionSelect)
    returnData = VendorInterface.onChangeOfActionSelect(changedAction, dataSources);
  if (returnData == false) {
    return;
  }
}


function onCreateVendorBtnClick(e) {
  e.preventDefault();

  var vendorObj = {};

  vendorObj.business_partner_id = vendorBusiness_partner_id.getAttribute('Business_partner_id');
  vendorObj.isactive = vendorIsactive.checked;
  var date = new Date();
  vendorObj.created_by = userObj.username;
  vendorObj.created_on = date.getTime();
  vendorObj.modified_on = date.getTime();
  vendorObj.modified_by = userObj.username;

  //Validate the vendor object
  var checkVendor = validate(vendorObj);

  //In validation is successfull
  if (checkVendor == true) {





    if (VendorInterface && VendorInterface.onBeforeCreate)
      vendorObj = VendorInterface.onBeforeCreate(vendorObj, dataSources);
    if (vendorObj == false) {
      return;
    }


    clCommon.showLoader("createProgress");
    clCommon.disable(createVendorBtn);


    Service.createVendor(vendorObj, function(resultObj) {
      if (resultObj.code == 200) { //on success response
        clCommon.hideLoader("createProgress");
        clCommon.enable(createVendorBtn);
        s_toast(Strings.CREATE_VENDOR_TOAST_SUCCESS);
        var isSuccessful = true;


        if (VendorInterface && VendorInterface.onAfterCreate)
          vendorObj = VendorInterface.onAfterCreate(isSuccessful, resultObj.data, dataSources);

        if (vendorObj == false) {
          return;
        }

        clCommon.setCookie("vendor_id", resultObj.data._sid, 10);
        primaryArr.push(resultObj.data);

        addRow(resultObj.data);

      } else {
        var isSuccessful = false;


        if (VendorInterface && VendorInterface.onAfterCreate)
          vendorObj = VendorInterface.onAfterCreate(isSuccessful, resultObj.data, dataSources);

        if (vendorObj == false) {
          return;
        }

        s_error(Strings.VENDOR_ERROR_TITLE, Strings.CREATE_VENDOR_ERROR, dlgOptions);
      }
    });
  }
}

// Function to add a new row at the top
function addRow(newData) {



  // Add row to table
  var rowNode = vendorTable.row.add(newData).node();

  // Draw the table to render the new data (triggers renderData)
  vendorTable.draw(false);

  // Handle sorting to bring new item to top (visual preference)
  var rows = vendorTable.rows().data().toArray();
  // Check if the last item is our new item
  if (rows.length > 0 && rows[rows.length - 1]._sid === newData._sid) {
    rows.unshift(rows.pop());
    vendorTable.clear().rows.add(rows).draw(false);
  }

  // 5. Select the row
  selectRowBySid(newData._sid);
}



function onRowClick(e) {

  var isFullCookie = clCommon.getCookie("bcssteam_full_view");

  if (!selectedRow) { //executes when the row is clicked for the first time
    selectedRow = this;
    $(selectedRow).addClass('selected');

    deleteVendorBtn.classList.remove('disabled');


    clCommon.hide(createBtn);
    clCommon.show(updateBtn);

    clCommon.focus(vendorBusiness_partner_id);
    selectedRow = this;

    rowData = vendorTable.row(selectedRow).data();


    vendorBusiness_partner_id.setAttribute("Business_partner_id", rowData.business_partner_id ? rowData.business_partner_id : "");
    vendorBusiness_partner_id.dispatchEvent(new Event('change'));

    selectedBusiness_partner_idId = rowData.business_partner_id ? rowData.business_partner_id : "";

    var businessPartnerArr = dataSources.getAllBusinessPartner; // Dynamically fetch array
    for (var i = 0; i < businessPartnerArr.length; i++) {
      var obj = businessPartnerArr[i];
      if (rowData.business_partner_id == obj._sid) {
        vendorBusiness_partner_id.value = obj.name ? obj.name : "";
        break;
      }
    }


    if (VendorInterface && VendorInterface.onRowItemClick)
      rowData = VendorInterface.onRowItemClick(rowData);

    displayForm(rowData);
  } else {

    if (selectedRow === this && isFullCookie === "true" && !clCommon.isMobile()) {
      return;
    }

    if (clCommon.isMobile() || (selectedRow != this) || (selectedRow == this)) { //executed when another row is selected
      $(selectedRow).removeClass('selected');

      deleteVendorBtn.classList.add('disabled');


      clearForm();

      selectedRow = this;
      $(selectedRow).addClass('selected');

      deleteVendorBtn.classList.remove('disabled');


      clCommon.hide(createBtn);
      clCommon.show(updateBtn);
      clCommon.focus(vendorBusiness_partner_id);
      selectedRow = this;
      rowData = vendorTable.row(selectedRow).data();


      vendorBusiness_partner_id.setAttribute("Business_partner_id", rowData.business_partner_id ? rowData.business_partner_id : "");
      vendorBusiness_partner_id.dispatchEvent(new Event('change'));

      selectedBusiness_partner_idId = rowData.business_partner_id ? rowData.business_partner_id : "";

      var businessPartnerArr = dataSources.getAllBusinessPartner; // Dynamically fetch array
      for (var i = 0; i < businessPartnerArr.length; i++) {
        var obj = businessPartnerArr[i];
        if (rowData.business_partner_id == obj._sid) {
          vendorBusiness_partner_id.value = obj.name ? obj.name : "";
          break;
        }
      }


      if (VendorInterface && VendorInterface.onRowItemClick)
        rowData = VendorInterface.onRowItemClick(rowData);

      displayForm(rowData);
    }
  }

  if (clCommon.isMobile()) {
    showForm();
  } else {
    if (isFullCookie === "true") {
      hideForm();
    }
  }
}


//This function displays all the data in corresponsing controls
function displayForm(rowData) {

  vendorBusiness_partner_id.value = rowData.business_partner_id;
  vendorBusiness_partner_id.dispatchEvent(new Event("change"));
  vendorIsactive.checked = rowData.isactive;



  if (VendorInterface && VendorInterface.onDisplayForm)
    rowData = VendorInterface.onDisplayForm(rowData);

}


function onUpdateVendorBtnClick(e) {
  e.preventDefault();

  var vendorObj = {};

  vendorObj.business_partner_id = vendorBusiness_partner_id.getAttribute('Business_partner_id');
  vendorObj.isactive = vendorIsactive.checked;

  vendorObj._sid = rowData._sid;
  var date = new Date();
  vendorObj.modified_on = date.getTime();
  vendorObj.modified_by = userObj.username;
  vendorObj.created_by = rowData.created_by ? rowData.created_by : userObj.username;
  vendorObj.created_on = rowData.created_on ? rowData.created_on : null;

  //Validate the vendor object
  var checkVendor = validate(vendorObj);

  //In validation is successfull
  if (checkVendor == true) {




    if (VendorInterface && VendorInterface.onBeforeUpdate)
      vendorObj = VendorInterface.onBeforeUpdate(vendorObj, dataSources);
    if (vendorObj == false) {
      return;
    }


    clCommon.showLoader("updateProgress");
    clCommon.disable(updateVendorBtn);

    Service.updateVendor(vendorObj, function(resultObj) {
      if (resultObj.code == 200) { //on success response
        clCommon.hideLoader("updateProgress");
        clCommon.enable(updateVendorBtn);
        s_toast(Strings.UPDATE_VENDOR_TOAST_SUCCESS);

        var isSuccessful = true;


        if (VendorInterface && VendorInterface.onAfterUpdate)
          vendorObj = VendorInterface.onAfterUpdate(isSuccessful, resultObj.data, dataSources);
        if (vendorObj == false) {
          return;
        }


        clCommon.setCookie("vendor_id", resultObj.data._sid, 10);

        var index = primaryArr.findIndex(obj => obj._sid === resultObj.data._sid);

        if (index !== -1) {
          // Insert at the index where _sid matches
          primaryArr.splice(index, 0, resultObj.data);
        } else {
          // If not found, optionally push to end
          primaryArr.push(resultObj.data);
        }

        updateRowBySid(resultObj.data._sid, resultObj.data);

      } else {
        var isSuccessful = false;


        if (VendorInterface && VendorInterface.onAfterUpdate)
          vendorObj = VendorInterface.onAfterUpdate(isSuccessful, resultObj.data, dataSources);
        if (vendorObj == false) {
          return;
        }


        s_error(Strings.VENDOR_ERROR_TITLE, Strings.UPDATE_VENDOR_ERROR, dlgOptions);
      }
    });
  }
}

// Function to update a row by _sid
function updateRowBySid(sid, updatedData) {



  // Find the existing row index
  var rowIndexes = vendorTable.rows().indexes().toArray();
  var foundIndex = -1;

  // Manual search to be precise
  for (var i = 0; i < rowIndexes.length; i++) {
    var d = vendorTable.row(rowIndexes[i]).data();
    if (d && d._sid === sid) {
      foundIndex = rowIndexes[i];
      break;
    }
  }

  if (foundIndex !== -1) {
    // 1. Update the data in place (better than remove/add for maintaining state)
    vendorTable.row(foundIndex).data(updatedData);

    // 2. Invalidate the row to force re-render (Runs renderData again)
    vendorTable.row(foundIndex).invalidate().draw(false);

    // 3. Move to top (Optional, to match your previous logic)
    var rows = vendorTable.rows().data().toArray();
    // Find our updated object in the array
    var internalIdx = rows.findIndex(function(r) {
      return r._sid === sid;
    });
    if (internalIdx > 0) {
      var item = rows.splice(internalIdx, 1)[0];
      rows.unshift(item);
      vendorTable.clear().rows.add(rows).draw(false);
    }
  }

  selectRowBySid(sid);
}


// Function to select a row by _sid and trigger onRowClick
function selectRowBySid(sid) {
  if (sid == null) return;

  var table = vendorTable;
  var pageLen = table.page.len();

  // Find the row by _sid
  var target = table.row(function(idx, data) {
    return data && data._sid === sid;
  });

  // Fallback: first row on current page if not found (and table not empty)
  if (!target.any()) {
    var first = table.row(':eq(0)', {
      page: 'current'
    });
    if (!first.any()) return; // empty table

    table.one('draw', function() {
      // Clear all current selections
      table.rows({
        page: 'current'
      }).every(function() {
        this.node().classList.remove('selected');
      });

      var firstNode = first.node();
      firstNode.classList.add('selected');

      // Trigger click
      firstNode.dispatchEvent(new Event('click', {
        bubbles: true
      }));
    });

    table.draw(false);
    return;
  }

  // Compute the display position (after search/order) to know the page number
  var rowIdx = target.index(); // DataTables internal index
  var displayIdxs = table.rows({
    search: 'applied',
    order: 'applied'
  }).indexes().toArray();
  var pos = displayIdxs.indexOf(rowIdx);
  var pageIndex = (pos > -1) ? Math.floor(pos / pageLen) : table.page();

  // After the table redraws to the right page, re-find & select the row, then click
  table.one('draw', function() {
    var r = table.row(function(i, d) {
      return d && d._sid === sid;
    });
    if (!r.any()) return;

    // Clear current selections
    table.rows({
      page: 'current'
    }).every(function() {
      this.node().classList.remove('selected');
    });

    var node = r.node();
    node.classList.add('selected');

    // Trigger click
    node.dispatchEvent(new Event('click', {
      bubbles: true
    }));
  });

  table.page(pageIndex).draw(false);


  var isFullCookie = clCommon.getCookie("bcssteam_full_view");
  if (isFullCookie === "true") {
    //clCommon.show(contentView);
    //clCommon.hide(formView);
    hideForm();
    if (selectedRow) {
      $(selectedRow).removeClass('selected');
      selectedRow = null;
    }
    deleteVendorBtn.classList.add('disabled');
  }
}




function onAddVendorBtnClick(e) {
  e.preventDefault();
  clearForm();

  if (clCommon.isMobile()) {
    showForm();
  } else {
    var isFullCookie = clCommon.getCookie("bcssteam_full_view");
    if (isFullCookie === "true") {
      toggleFullview(true);
    }
  }

  deleteVendorBtn.classList.add('disabled');


}



function clearForm() {
  var defaultObj = {
    "business_partner_id": "",
    "isactive": false
  };


  clCommon.hide(business_partner_idPnl);
  vendorBusiness_partner_id.setAttribute("Business_partner_id", "");
  selectedBusiness_partner_idId = defaultObj.business_partner_id;




  if (VendorInterface && VendorInterface.onClearForm) {
    var modDefaultObj = VendorInterface.onClearForm(defaultObj, dataSources);
    for (var attr in modDefaultObj) {
      if (modDefaultObj.hasOwnProperty(attr)) {
        defaultObj[attr] = modDefaultObj[attr]; // Apply changes to defaultObj
      }
    }
  }
  if (!clCommon.isMobile()) {
    clCommon.show(formView);
  }

  displayForm(defaultObj);

  clCommon.hide(updateBtn);
  clCommon.show(createBtn);

  deleteVendorBtn.classList.add('disabled');


  rowData = "";

  clCommon.focus(vendorBusiness_partner_id);

  if (selectedRow) {
    $(selectedRow).removeClass('selected');
  }

  selectedRow = "";
}



function onDeleteVendorBtnClick() {
  var clArr = deleteVendorBtn.classList;
  if (clArr.contains('disabled') == false)
    s_confirm(Strings.CONFIRM, Strings.VENDOR_DELETE_CONFIRM + " - " + rowData.business_partner_name + Strings.DELETE_TITLE_VENDOR + " ?", { //Confirmation with user
      STR_YES: dlgOptions.STR_YES,
      STR_NO: dlgOptions.STR_NO,
      onYes: function() { //on approval
        clCommon.showLoader("removeProgress");

        if (VendorInterface && VendorInterface.onBeforeDelete)
          rowData = VendorInterface.onBeforeDelete(rowData, dataSources);
        if (rowData == false) {
          clCommon.hideLoader("removeProgress");
          return;
        }


        Service.deleteVendor(rowData._sid, function(resultObj) {
          if (resultObj.code == 200) { //on Success response
            clCommon.hideLoader("removeProgress");

            var isSuccessful = true;

            var afterDelete = true;
            if (VendorInterface && VendorInterface.onAfterDelete)
              afterDelete = VendorInterface.onAfterDelete(isSuccessful, resultObj, dataSources);
            if (afterDelete == false) {
              return;
            }


            deleteVendorBtn.classList.add('disabled');

            removeRowBySid(rowData._sid);

            var index = primaryArr.findIndex(item => item._sid === rowData._sid);

            if (index !== -1) {
              primaryArr.splice(index, 1);
            }

            s_toast(Strings.DELETE_VENDOR_TOAST_SUCCESS);
          } else { //On Error response
            var isSuccessful = false;

            var afterDelete = true;
            if (VendorInterface && VendorInterface.onAfterDelete)
              afterDelete = VendorInterface.onAfterDelete(isSuccessful, resultObj, dataSources);
            if (afterDelete == false) {
              return;
            }

            s_error(Strings.VENDOR_ERROR_TITLE, Strings.DELETE_VENDOR_ERROR, dlgOptions);
            clCommon.hideLoader("removeProgress");
          }
        });
      }
    });
}

// Function to remove a row by _sid
function removeRowBySid(sid) {
  // Remove the row that matches the provided sid
  vendorTable.rows(function(idx, data, node) {
    return data._sid === sid; // Find row where _sid matches
  }).remove().draw(); // Remove and redraw the table

  if (vendorTable.data().any()) {
    // Select the first row in the current page
    var firstRowNode = vendorTable.row(':eq(0)', {
      page: 'current'
    }).node();
    if (firstRowNode) {


      clCommon.enable(deleteVendorBtn);

      $(firstRowNode).addClass('selected');
      $(firstRowNode).trigger('click'); // Trigger the click event to simulate row selection
    }
  }
}



function onFieldFocus(e) {
  e.preventDefault();
  var focusedField = this;




  if (VendorInterface && VendorInterface.onFieldFocus)
    var returnData = VendorInterface.onFieldFocus(focusedField, dataSources);
}


function onFieldChange(e) {
  e.preventDefault();
  var changedField = this;


  if (changedField.id == "vendorBusiness_partner_id") {
    for (var dt in dataSources.getAllBusinessPartner) {
      var dtObj = dataSources.getAllBusinessPartner[dt];
      if (selectedBusiness_partner_idId && selectedBusiness_partner_idId == dtObj._sid) {
        vendorBusiness_partner_id.value = dtObj.name ? dtObj.name : "";
        break;
      }
    }
  }




  var dependentFieldArr = document.querySelectorAll(".form-holder [data-dependent=" + changedField.id + "]");
  if (dependentFieldArr.length > 0) {
    for (var idx = 0; idx < dependentFieldArr.length; idx++) {
      var dependentField = dependentFieldArr[idx];
      var dataSrcFunction = dependentField.getAttribute("data-srcFunc");
      if (dataSrcFunction) {
        delete window.dataSources[dataSrcFunction];
        var functionCall = window[dataSrcFunction].call(window, true, changedField);
      } else {
        if (VendorInterface && VendorInterface.onFieldChange)
          var returnData = VendorInterface.onFieldChange(changedField, dataSources);
      }
    }
  } else {
    if (VendorInterface && VendorInterface.onFieldChange)
      var returnData = VendorInterface.onFieldChange(changedField, dataSources);
  }

}

function formattingNumberElements(fieldEl) {
  var raw = fieldEl.value.replace(/[^0-9.-]+/g, "");
  raw = raw === "" || isNaN(raw) ? 0 : Number(raw);
  fieldEl.setAttribute("val", raw);


  var decimalAttr = fieldEl.getAttribute("decimal");
  var decimalDigits = Number.isFinite(parseInt(decimalAttr)) ? parseInt(decimalAttr) : null;


  var currencyAttr = fieldEl.getAttribute("currency");
  var isCurrencyField = currencyAttr && currencyAttr.trim().toLowerCase() === "true";


  var currencyCode = (typeof slocale !== "undefined") ? slocale.getLocaleInfo(localeCode).currency_code : currency;


  if (isCurrencyField) {
    var currencyFormatForAmount = decimalDigits !== null ? new Intl.NumberFormat(localeCode, {
      style: "currency",
      currency: currencyCode,
      minimumFractionDigits: decimalDigits,
      maximumFractionDigits: decimalDigits
    }) : currencyFormat;


    fieldEl.value = currencyFormatForAmount.format(raw);
  } else {
    var numberFormatForAmount = decimalDigits !== null ? new Intl.NumberFormat(localeCode, {
      style: "decimal",
      minimumFractionDigits: decimalDigits,
      maximumFractionDigits: decimalDigits
    }) : numberFormat;


    fieldEl.value = numberFormatForAmount.format(raw);
  }
  return fieldEl;
}


function validate(vendorObj) {

  if (!vendorObj.business_partner_id) {
    s_info(Strings.VALIDATION_ERROR_TITLE, Strings.VENDOR_INVALID_BUSINESS_PARTNER_ID, dlgOptions);
    return false;
  }


  return true;
}


function containsOnlyLetters(str) {
  return /^[a-zA-Z\s]+$/.test(str);
}



function containsNumbers(str) {
  return /^[0-9.]+$/.test(str);
}




function onToolBarBtnClick(e) {
  e.preventDefault();
  var clickedBtn = this;
  var returnData = true;
  if (VendorInterface && VendorInterface.onToolBarBtnClick)
    returnData = VendorInterface.onToolBarBtnClick(clickedBtn, dataSources);
  if (returnData === false) {
    return;
  } else {
    var clArr;
    switch (clickedBtn.id) {
      case "loadMore":
        clArr = loadMore.classList;
        if (clArr.contains('disabled') == false)
          loadLimFunction(limit);
        break;
      case "loadAll":
        clArr = loadAll.classList;
        if (clArr.contains('disabled') == false)
          s_confirm(Strings.CONFIRM, Strings.CONFIRM_LOAD_ALL_PRT_1 + "?" + Strings.CONFIRM_LOAD_PRT_2, { //Confirm with the user 
            STR_YES: dlgOptions.STR_YES,
            STR_NO: dlgOptions.STR_NO,
            onYes: function() { //On positive confirmation
              primaryArr = [];
              loadMore.classList.add('disabled');
              loadAll.classList.add('disabled');
              loadLimFunction(0);

            }
          });

        break;


      case "vendorBusiness_partner_idZoom":
        onBusiness_partner_idZoomBtn();
        break;

    }
  }
}


function onLookupAddBtnClick(e) {
  e.preventDefault();
  var clickedBtn = this;
  var returnData = true;
  if (VendorInterface && VendorInterface.onLookupAddBtnClick)
    returnData = VendorInterface.onLookupAddBtnClick(clickedBtn.getAttribute('data-lookup-add'), clickedBtn, dataSources);
  if (returnData === false) {
    return;
  }
}









function initBusiness_partner_idTable() {
  business_partner_idTable = $('#business_partner_idTable').DataTable({
    paging: false,
    info: false,
    autoWidth: false,
    columns: [{
        data: 'radio'
      },
      {
        data: 'business_partner_idName'
      }
    ],
    columnDefs: [{
      "width": "25px",
      "targets": 0
    }]
  });
  business_partner_idTable.table().node().classList.remove('nowrap');
}

function onBusiness_partner_idZoomBtn(e) {
  clCommon.hide(formView);
  clCommon.show(business_partner_idPnl);
  openLookupView(business_partner_idPnl);
  var pushState = (e !== false);
  var business_partner_idArr = [];
  var business_partner_idFlg = false;
  var objective = {
    "_sid": vendorBusiness_partner_id.getAttribute("Business_partner_id")
  };
  var check = true;
  if (VendorInterface && VendorInterface.onLookUpData) {
    check = VendorInterface.onLookUpData("business_partner_id", dataSources);
  }
  if (check == false) return;

  for (var item of dataSources.getAllBusinessPartner) {
    var checked = "";
    if (objective._sid && objective._sid == item._sid) {
      checked = "checked";
      business_partner_idFlg = true;
    } else if (rowData && rowData.business_partner_id == item._sid && !business_partner_idFlg) {
      checked = "checked";
    }

    business_partner_idArr.push({
      "business_partner_idName": '<label for="' + item._sid + '">' + item.name + '</label>',
      "radio": '<input type="radio" name="business_partner_idName" business_partner_idId="' + item._sid + '" business_partner_idName="' + JSON.stringify(item).replaceAll('"', '$' + 'DQUOTE' + '$') + '" ' + checked + '>'
    });
  }

  business_partner_idTable.clear().draw();
  business_partner_idTable.rows.add(business_partner_idArr).draw();

  if (clCommon.isMobile() && pushState) {
    window.history.pushState('business_partner_idForm', null, '#business_partner_idsForm');
    clCommon.hide(contentView);
  }
}

function onRelateBusiness_partner_idBtn(e) {
  var selectedObj = document.querySelector('input[name="business_partner_idName"]:checked');
  if (!selectedObj) {
    s_info(Strings.VENDOR_ALERT_TITLE, Strings.VENDOR_INVALID_BUSINESS_PARTNER_ID, dlgOptions);
    return;
  }

  var objective = JSON.parse(selectedObj.getAttribute("business_partner_idName").replaceAll('$DQUOTE$', '"'));
  vendorBusiness_partner_id.value = objective.name || "";
  vendorBusiness_partner_id.setAttribute("Business_partner_id", objective._sid || "");
  selectedBusiness_partner_idId = objective._sid || "";

  vendorBusiness_partner_id.dispatchEvent(new Event('change'));
  clCommon.hide(business_partner_idPnl);
  clCommon.show(formView);
  closeLookupView(business_partner_idPnl);
}

function onSearchBusiness_partner_id() {
  const searchInput = document.getElementById('searchBusiness_partner_idBox');
  if (business_partner_idTable && searchInput) {
    business_partner_idTable.search(searchInput.value).draw();
  }
}

function onCancelBusiness_partner_idBtn(e) {
  clCommon.hide(business_partner_idPnl);
  clCommon.show(formView);
  closeLookupView(business_partner_idPnl);
}

function onBusiness_partner_idMobBackBtn(e) {
  history.back();
}